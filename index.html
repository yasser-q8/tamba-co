<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة العملاء - شركة مجموعة تامبا الذهبية</title>
    <link rel="icon" href="https://i.postimg.cc/3xZmVcrP/YASR.jpg" type="image/jpeg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4a90e2;
            --primary-light: #7bb3f0;
            --primary-dark: #2c6cb0;
            --secondary: #FF6B35;
            --secondary-light: #ff8e62;
            --accent: #28a745;
            --accent-light: #5cdb7a;
            --danger: #dc3545;
            --danger-light: #e96d79;
            --warning: #ffc107;
            --warning-light: #ffd965;
            --info: #17a2b8;
            --info-light: #5bc0de;
            --dark: #343a40;
            --light: #f8f9fa;
            --border: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --gradient-primary: linear-gradient(135deg, #4a90e2 0%, #2c6cb0 100%);
            --gradient-secondary: linear-gradient(135deg, #FF6B35 0%, #ff8e62 100%);
            --gradient-accent: linear-gradient(135deg, #28a745 0%, #5cdb7a 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Times New Roman', serif;
        }
        
        body {
            background-color: #e8f4fd !important;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1450px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles */
        header {
            background: var(--gradient-primary);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            width: 70px;
            height: 70px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: bold;
            margin-left: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-size: 1.2rem;
            border: 3px solid var(--secondary);
            overflow: hidden;
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .company-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            font-family: 'Times New Roman', serif;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav li {
            margin: 0 5px;
        }
        
        nav a {
            text-decoration: none;
            color: white;
            padding: 10px 18px;
            border-radius: 30px;
            transition: all 0.3s;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: 'Times New Roman', serif;
        }
        
        nav a:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        nav a.active {
            background: var(--warning);
            color: var(--dark);
            transform: translateY(-2px);
        }
        
        /* Main Content Styles */
        main {
            padding: 20px 0;
            min-height: calc(100vh - 140px);
        }
        
        .page {
            display: none;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            border-top: 5px solid var(--primary);
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--light);
        }
        
        .page-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            font-family: 'Times New Roman', serif;
        }
        
        .page-title i {
            margin-left: 10px;
            color: var(--secondary);
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
            flex: 1;
            min-width: 180px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
            font-family: 'Times New Roman', serif;
        }
        
        input, select, textarea {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: white;
            width: 100%;
            box-sizing: border-box;
            font-family: 'Times New Roman', serif;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            margin-bottom: 0;
        }
        
        /* تحديد أحخاص الحقول */
        .input-small {
            width: 150px;
        }
        
        .input-medium {
            width: 200px;
        }
        
        .input-large {
            width: 250px;
        }
        
        .input-customer {
            width: 290px;
        }
        
        .input-amount {
            text-align: left;
            direction: ltr;
        }
        
        .input-date {
            width: 160px;
        }
        
        .input-balance {
            width: 160px !important;
            text-align: left !important;
            direction: ltr !important;
            background-color: #f0f8ff !important;
            color: #1976d2 !important;
            cursor: not-allowed !important;
            border: 1px solid #bbdefb !important;
            font-weight: bold !important;
            border-radius: 4px !important;
        }

        .input-branch {
            min-width: 180px;
        }

        .input-salesman {
            min-width: 180px;
        }

        textarea {
            min-height: 42px;
            resize: both;
            overflow: auto;
            width: 100% !important;
        }
        
        .textarea-small {
            min-height: 42px;
            height: 42px;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 42px;
            white-space: nowrap;
            font-family: 'Times New Roman', serif;
        }
        
        .btn i {
            font-size: 1rem;
        }
        
        .btn-sm {
            padding: 8px 14px;
            font-size: 0.9rem;
            height: 36px;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 8px rgba(74, 144, 226, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(74, 144, 226, 0.4);
        }
        
        .btn-success {
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #8a939b 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(108, 117, 125, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
            color: var(--dark);
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 193, 7, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, var(--info-light) 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(23, 162, 184, 0.4);
        }
        
        .btn-print {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(73, 80, 87, 0.3);
        }
        
        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(73, 80, 87, 0.4);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        .inline-buttons {
            display: flex;
            gap: 8px;
            margin-top: 0;
        }
        
        .form-buttons {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            margin-top: 0;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            overflow: hidden;
            font-size: 0.9rem;
            font-family: 'Times New Roman', serif;
        }
        
        th, td {
            padding: 12px 14px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        tr:hover {
            background-color: rgba(74, 144, 226, 0.03);
        }
        
        /* Search Container */
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .customer-search-input {
            width: 100% !important;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        
        .search-result-item:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--secondary);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--light);
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.6rem;
            cursor: pointer;
            color: var(--dark);
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--danger);
        }
        
        /* Footer Styles */
        footer {
            background: var(--gradient-primary);
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-top: 20px;
        }
        
        /* Utility Classes */
        .text-right {
            text-align: right !important;
        }
        
        .text-left {
            text-align: left !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-success {
            color: var(--accent);
            font-weight: 600;
        }
        
        .text-danger {
            color: var(--danger);
            font-weight: 600;
        }
        
        .text-warning {
            color: var(--warning);
            font-weight: 600;
        }
        
        .mt-15 {
            margin-top: 15px;
        }
        
        .mb-15 {
            margin-bottom: 15px;
        }
        
        .hidden {
            display: none;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
            border-top: 4px solid var(--primary);
        }
        
        .card-header {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light);
        }
        
        /* Search and Filter Bar */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .search-bar .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 0;
        }
        
        /* Print Styles */
        @media print {
            header, footer, nav, .action-buttons, .btn-print, .search-bar, .no-print {
                display: none !important;
            }
            
            .page {
                box-shadow: none;
                padding: 0;
                border: none;
                margin: 0;
            }
            
            body {
                background-color: white;
                font-size: 12pt;
            }
            
            th {
                background: #f0f0f0 !important;
                color: black !important;
            }
        }
        
        /* تكبير الخط ومحاذاة قيمة الفاتورة إلى اليمين */
        #invoice-amount {
            font-size: 20px !important;
            text-align: right !important;
        }

        /* تكبير الخط ومحاذاة الرصيد الحالي إلى اليمين */
        #current-balance {
            font-size: 30px !important;
            text-align: right !important;
        }

        /* تكبير الخط ومحاذاة المبلغ المسدد إلى اليمين */
        #payment-amount {
            font-size: 30px !important;
            text-align: right !important;
        }

        /* تحسينات إضافية لشاشة التحصيل */
        .input-customer-large {
            min-width: 300px;
        }
        
        .input-voucher {
            min-width: 150px;
        }
        
        .input-discount {
            min-width: 140px;
            text-align: left;
            direction: ltr;
        }

        .discount-type-selector {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .discount-type-btn {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .discount-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* تكبير الخطوط في شاشة التحصيل */
        #payment-amount, #discount-amount, #current-balance {
            font-size: 18px !important;
            text-align: right !important;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .form-row .form-group {
                width: 100%;
            }
        }

        /* أنماط كشف الحساب - محسنة */
        .statement-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .statement-header {
            text-align: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .statement-header h2 {
            color: #4a90e2;
            margin-bottom: 15px;
            font-size: 24px;
            font-family: 'Times New Roman', serif;
        }
        
        .statement-header h3 {
            color: #4a90e2;
            font-size: 20px;
            margin-bottom: 25px;
        }
        
        .statement-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
            font-size: 16px;
        }
        
        .customer-name-large {
            font-size: 24px; /* أكبر 20% */
            font-weight: bold;
            margin-bottom: 20px; /* مسافة حوالي 2 سم */
        }
        
        .branch-info {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .period-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .statement-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-right: 4px solid #4a90e2;
        }
        
        .statement-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .statement-table th {
            background: #4a90e2;
            color: white;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .statement-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
            min-height: 42px; /* ارتفاع الصف 35% أكبر */
        }
        
        .statement-table tr {
            height: 42px; /* ارتفاع الصف 35% أكبر */
        }
        
        .statement-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .debit-amount {
            color: #dc3545;
            font-weight: bold;
        }
        
        .credit-amount {
            color: #28a745;
            font-weight: bold;
        }
        
        .discount-amount {
            color: #ffc107;
            font-weight: bold;
        }
        
        .balance-amount {
            color: #007bff;
            font-weight: bold;
        }
        
        /* صف الإجماليات */
        .totals-row {
            background-color: #f0f8ff !important;
            font-weight: bold;
            border-top: 2px solid #4a90e2;
        }
        
        .totals-row td:first-child {
            text-align: center;
            font-weight: bold;
        }
        
        /* تنسيق خاص للطباعة */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .statement-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            
            .statement-header {
                border-bottom: 2px solid #000;
            }
            
            .statement-table th {
                background: #f0f0f0 !important;
                color: #000 !important;
            }
            
            .statement-table td {
                min-height: 42px;
                height: 42px;
            }
        }
        
        /* PDF container styling */
        #pdf-container {
            background: white;
            padding: 20px;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .pdf-header {
            text-align: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .pdf-header h2 {
            color: #4a90e2;
            margin: 0 0 10px 0;
            font-size: 24px;
            font-family: 'Times New Roman', serif;
        }
        
        .pdf-company-info {
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
        }

        .pdf-logo {
            text-align: center;
            margin-bottom: 15px;
        }

        .pdf-logo img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #4a90e2;
        }

        /* أنماط مخفية لـ PDF */
        .pdf-template {
            position: fixed;
            left: -10000px;
            top: -10000px;
            width: 794px;
            height: 1123px;
            background: white;
            padding: 40px;
            box-sizing: border-box;
            z-index: -1000;
            font-size: 14px;
            font-family: 'Times New Roman', serif;
        }

        /* Payment Type Styles */
        .payment-type-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .payment-type-btn {
            padding: 8px 16px;
            border: 2px solid #ccc;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .payment-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .payment-details {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        /* Sales Report Card */
        .sales-report-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-right: 4px solid var(--primary);
        }
        
        .report-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* تحسينات جديدة لأعمدة كشف الحساب */
        .statement-table th:nth-child(1) { /* التاريخ */
            width: 12% !important; /* زاد 10% */
        }
        
        .statement-table th:nth-child(2) { /* رقم الفاتورة */
            width: 7% !important; /* صغر قليلاً */
        }
        
        .statement-table th:nth-child(3) { /* رقم السند */
            width: 8% !important;
        }
        
        .statement-table th:nth-child(4) { /* المندوب */
            width: 8% !important;
        }
        
        .statement-table th:nth-child(5) { /* الفرع */
            width: 12% !important; /* كبر قليلاً */
        }
        
        .statement-table th:nth-child(6) { /* البيان */
            width: 38% !important; /* قلل قليلاً */
        }
        
        .statement-table th:nth-child(7), /* مدين */
        .statement-table th:nth-child(8), /* دائن */
        .statement-table th:nth-child(9) { /* الرصيد */
            width: 8% !important;
        }
        
        /* محاذاة الأرقام لليمين (مطلوب) */
        .statement-table td:nth-child(1) { /* التاريخ - صغر حجم الكلام 5% */
            font-size: 12px;
            direction: ltr;
            text-align: left !important;
        }
        
        .statement-table td:nth-child(7),
        .statement-table td:nth-child(8),
        .statement-table td:nth-child(9) {
            text-align: left !important;
            direction: ltr !important;
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 1100px) {
            .form-row {
                flex-wrap: wrap;
            }
            
            .form-row .form-group {
                flex: 1 0 calc(50% - 12px);
            }
        }
        
        @media (max-width: 768px) {
            .form-row .form-group {
                flex: 1 0 100%;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 10px;
            }
            
            .company-name {
                font-size: 1.5rem;
            }
            
            .statement-table th:nth-child(1),
            .statement-table th:nth-child(2),
            .statement-table th:nth-child(3),
            .statement-table th:nth-child(4),
            .statement-table th:nth-child(5),
            .statement-table th:nth-child(6),
            .statement-table th:nth-child(7),
            .statement-table th:nth-child(8),
            .statement-table th:nth-child(9) {
                width: auto !important;
            }
        }
        
        /* تنسيق جديد لشاشة مرتجع المبيعات */
        .return-form .btn-primary {
            background: linear-gradient(135deg, #dc3545 0%, #e96d79 100%);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .return-form .btn-primary:hover {
            box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo" id="company-logo">
                        <img src="https://i.postimg.cc/rFmJ1c8z/logo.png" alt="شعار الشركة">
                    </div>
                    <div class="company-name" id="company-name">شركة مجموعة تامبا الذهبية</div>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="nav-link active" data-page="customers"><i class="fas fa-file-invoice"></i> الفواتير</a></li>
                        <li><a href="#" class="nav-link" data-page="returns"><i class="fas fa-undo-alt"></i> مرتجع المبيعات</a></li>
                        <li><a href="#" class="nav-link" data-page="payments"><i class="fas fa-money-bill-wave"></i> التحصيل</a></li>
                        <li><a href="#" class="nav-link" data-page="statements"><i class="fas fa-chart-line"></i> كشف الحساب</a></li>
                        <li><a href="#" class="nav-link" data-page="all-customers"><i class="fas fa-users"></i> العملاء</a></li>
                        <li><a href="#" class="nav-link" data-page="salesmen"><i class="fas fa-user-tie"></i> المندوبين</a></li>
                        <li><a href="#" class="nav-link" data-page="opening-balances"><i class="fas fa-balance-scale"></i> الرصيد الافتتاحي</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- صفحة تسجيل فواتير العملاء -->
            <section id="customers" class="page active">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-file-invoice"></i> تسجيل فواتير العملاء</h2>
                    <button class="btn btn-secondary" id="add-customer-btn"><i class="fas fa-user-plus"></i> اضافة عميل جديد</button>
                </div>
                
                <!-- Sales Report Card -->
                <div class="sales-report-card">
                    <h4><i class="fas fa-chart-bar"></i> إحصائيات المبيعات</h4>
                    <div class="report-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="total-invoices-count">0</div>
                            <div class="stat-label">عدد الفواتير</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-invoices-amount">0.00</div>
                            <div class="stat-label">إجمالي المبيعات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="today-invoices-count">0</div>
                            <div class="stat-label">فواتير اليوم</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="today-invoices-amount">0.00</div>
                            <div class="stat-label">مبيعات اليوم</div>
                        </div>
                    </div>
                </div>
                
                <form id="invoice-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-date"><i class="fas fa-calendar-alt"></i> تاريخ الفاتورة</label>
                            <input type="date" id="invoice-date" class="input-date" required>
                        </div>
                        <div class="form-group">
                            <label for="invoice-customer"><i class="fas fa-user-tie"></i> اسم العميل</label>
                            <div class="search-container">
                                <input type="text" id="invoice-customer" class="input-customer-large customer-search-input" 
                                       placeholder="ابحث عن العميل..." required autocomplete="off">
                                <div class="search-results" id="invoice-customer-results"></div>
                            </div>
                            <input type="hidden" id="invoice-customer-id">
                        </div>
                        <div class="form-group">
                            <label for="invoice-branch"><i class="fas fa-code-branch"></i> الفرع (اختياري)</label>
                            <div class="search-container">
                                <input type="text" id="invoice-branch" class="input-branch customer-search-input" 
                                       placeholder="اختر فرعاً..." autocomplete="off">
                                <div class="search-results" id="invoice-branch-results"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="invoice-amount"><i class="fas fa-money-bill"></i> قيمة الفاتورة</label>
                            <input type="number" id="invoice-amount" class="input-amount" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-number"><i class="fas fa-hashtag"></i> رقم الفاتورة</label>
                            <input type="text" id="invoice-number" class="input-small">
                        </div>
                        <div class="form-group">
                            <label for="invoice-salesman"><i class="fas fa-user-tag"></i> المندوب</label>
                            <div class="search-container">
                                <input type="text" id="invoice-salesman" class="input-salesman customer-search-input" 
                                       placeholder="اختر مندوباً..." required autocomplete="off">
                                <div class="search-results" id="invoice-salesman-results"></div>
                            </div>
                            <input type="hidden" id="invoice-salesman-id">
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label for="invoice-description"><i class="fas fa-sticky-note"></i> البيان</label>
                            <textarea id="invoice-description" rows="1" placeholder="وصف الفاتورة..."></textarea>
                        </div>
                        <div class="form-group form-buttons">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ الفاتورة</button>
                        </div>
                    </div>
                </form>
                
                <div class="card mt-15">
                    <div class="card-header">بحث الفواتير</div>
                    <div class="search-bar">
                        <div class="form-group">
                            <input type="text" id="search-invoice-number" class="input-medium" placeholder="ابحث برقم الفاتورة...">
                        </div>
                        <div class="form-group">
                            <div class="search-container">
                                <input type="text" id="search-invoice-customer" class="input-customer customer-search-input" placeholder="ابحث عن العميل...">
                                <div class="search-results" id="search-invoice-customer-results"></div>
                            </div>
                            <input type="hidden" id="search-invoice-customer-id">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-info" id="search-invoice-btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-secondary" id="reset-invoice-search"><i class="fas fa-redo"></i> إعادة</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-15">
                    <h3><i class="fas fa-list"></i> الفواتير المسجلة</h3>
                    <div class="search-bar">
                        <input type="text" id="search-invoice" class="input-medium" placeholder="ابحث في الفواتير...">
                    </div>
                    <button class="btn btn-primary" id="export-invoices">تصدير إلى Excel</button>
                    <table id="invoices-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>رقم الفاتورة</th>
                                <th>اسم العميل</th>
                                <th>الفرع</th>
                                <th>المندوب</th>
                                <th>القيمة</th>
                                <th>البيان</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- صفحة مرتجع المبيعات -->
            <section id="returns" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-undo-alt"></i> تسجيل مرتجع المبيعات</h2>
                </div>
                
                <form id="return-form" class="return-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="return-date"><i class="fas fa-calendar-alt"></i> تاريخ المرتجع</label>
                            <input type="date" id="return-date" class="input-date" required>
                        </div>
                        <div class="form-group">
                            <label for="return-customer"><i class="fas fa-user-tie"></i> اسم العميل</label>
                            <div class="search-container">
                                <input type="text" id="return-customer" class="input-customer-large customer-search-input" 
                                       placeholder="ابحث عن العميل..." required autocomplete="off">
                                <div class="search-results" id="return-customer-results"></div>
                            </div>
                            <input type="hidden" id="return-customer-id">
                        </div>
                        <div class="form-group">
                            <label for="return-branch"><i class="fas fa-code-branch"></i> الفرع (اختياري)</label>
                            <div class="search-container">
                                <input type="text" id="return-branch" class="input-branch customer-search-input" 
                                       placeholder="اختر فرعاً..." autocomplete="off">
                                <div class="search-results" id="return-branch-results"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="return-amount"><i class="fas fa-money-bill"></i> قيمة المرتجع</label>
                            <input type="number" id="return-amount" class="input-amount" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="return-number"><i class="fas fa-hashtag"></i> رقم المرتجع</label>
                            <input type="text" id="return-number" class="input-small">
                        </div>
                        <div class="form-group">
                            <label for="return-salesman"><i class="fas fa-user-tag"></i> المندوب</label>
                            <div class="search-container">
                                <input type="text" id="return-salesman" class="input-salesman customer-search-input" 
                                       placeholder="اختر مندوباً..." required autocomplete="off">
                                <div class="search-results" id="return-salesman-results"></div>
                            </div>
                            <input type="hidden" id="return-salesman-id">
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label for="return-description"><i class="fas fa-sticky-note"></i> سبب المرتجع</label>
                            <textarea id="return-description" rows="1" placeholder="سبب المرتجع..."></textarea>
                        </div>
                        <div class="form-group form-buttons">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ المرتجع</button>
                        </div>
                    </div>
                </form>
                
                <div class="card mt-15">
                    <div class="card-header">بحث المرتجعات</div>
                    <div class="search-bar">
                        <div class="form-group">
                            <input type="text" id="search-return-number" class="input-medium" placeholder="ابحث برقم المرتجع...">
                        </div>
                        <div class="form-group">
                            <div class="search-container">
                                <input type="text" id="search-return-customer" class="input-customer customer-search-input" placeholder="ابحث عن العميل...">
                                <div class="search-results" id="search-return-customer-results"></div>
                            </div>
                            <input type="hidden" id="search-return-customer-id">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-info" id="search-return-btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-secondary" id="reset-return-search"><i class="fas fa-redo"></i> إعادة</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-15">
                    <h3><i class="fas fa-list"></i> المرتجعات المسجلة</h3>
                    <div class="search-bar">
                        <input type="text" id="search-return" class="input-medium" placeholder="ابحث في المرتجعات...">
                    </div>
                    <button class="btn btn-primary" id="export-returns">تصدير إلى Excel</button>
                    <table id="returns-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>رقم المرتجع</th>
                                <th>اسم العميل</th>
                                <th>الفرع</th>
                                <th>المندوب</th>
                                <th>القيمة</th>
                                <th>السبب</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- صفحة تحصيل العملاء -->
            <section id="payments" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-money-bill-wave"></i> تحصيل العملاء</h2>
                </div>
                
                <!-- Payments Report Card -->
                <div class="sales-report-card">
                    <h4><i class="fas fa-chart-bar"></i> إحصائيات التحصيلات</h4>
                    <div class="report-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="total-payments-count">0</div>
                            <div class="stat-label">عدد التحصيلات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-payments-amount">0.00</div>
                            <div class="stat-label">إجمالي التحصيل</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="today-payments-count">0</div>
                            <div class="stat-label">تحصيلات اليوم</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="today-payments-amount">0.00</div>
                            <div class="stat-label">قيمة اليوم</div>
                        </div>
                    </div>
                </div>
                
               <form id="payment-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-date"><i class="fas fa-calendar-alt"></i> تاريخ التحصيل</label>
                            <input type="date" id="payment-date" class="input-date" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-customer"><i class="fas fa-user-tie"></i> اسم العميل</label>
                            <div class="search-container">
                                <input type="text" id="payment-customer" class="input-customer-large customer-search-input" 
                                       placeholder="ابحث عن العميل..." required autocomplete="off">
                                <div class="search-results" id="payment-customer-results"></div>
                            </div>
                            <input type="hidden" id="payment-customer-id">
                        </div>
                        <div class="form-group">
                            <label for="payment-branch"><i class="fas fa-code-branch"></i> الفرع</label>
                            <div class="search-container">
                                <input type="text" id="payment-branch" class="input-branch customer-search-input" 
                                       placeholder="اختر فرعاً..." autocomplete="off">
                                <div class="search-results" id="payment-branch-results"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-right: 0;">
                            <label for="payment-amount"><i class="fas fa-money-bill"></i> المبلغ المسدد</label>
                            <input type="number" id="payment-amount" class="input-amount" 
                                   step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><i class="fas fa-money-check"></i> طريقة الدفع</label>
                            <div class="payment-type-container">
                                <button type="button" class="payment-type-btn active" data-type="cash">نقدي</button>
                                <button type="button" class="payment-type-btn" data-type="check">شيك</button>
                            </div>
                            <input type="hidden" id="payment-type" value="cash">
                        </div>
                        <div class="form-group">
                            <label for="payment-voucher"><i class="fas fa-hashtag"></i> رقم السند</label>
                            <input type="text" id="payment-voucher" class="input-voucher">
                        </div>
                        <div class="form-group">
                            <label for="current-balance"><i class="fas fa-wallet"></i> الرصيد الحالي</label>
                            <input type="text" id="current-balance" class="input-balance" readonly placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="discount-type"><i class="fas fa-percentage"></i> نوع الخصم</label>
                            <div class="discount-type-selector">
                                <button type="button" class="discount-type-btn active" data-type="amount">مبلغ ثابت</button>
                                <button type="button" class="discount-type-btn" data-type="percentage">نسبة مئوية</button>
                            </div>
                            <input type="hidden" id="discount-type" value="amount">
                        </div>
                        <div class="form-group">
                            <label for="discount-amount"><i class="fas fa-percentage"></i> قيمة الخصم</label>
                            <input type="number" id="discount-amount" class="input-discount" step="0.01" min="0" placeholder="0.00">
                            <div id="discount-percentage" style="display: none; margin-top: 5px;">
                                <input type="number" id="discount-percent" style="width: 80px;" step="0.1" min="0" max="100" placeholder="0.0"> %
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check Details (Hidden by Default) -->
                    <div id="check-details" class="payment-details" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="check-number"><i class="fas fa-hashtag"></i> رقم الشيك</label>
                                <input type="text" id="check-number" class="input-medium">
                            </div>
                            <div class="form-group">
                                <label for="bank-name"><i class="fas fa-university"></i> اسم البنك</label>
                                <input type="text" id="bank-name" class="input-medium">
                            </div>
                            <div class="form-group">
                                <label for="check-date"><i class="fas fa-calendar-alt"></i> تاريخ الشيك</label>
                                <input type="date" id="check-date" class="input-date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label for="payment-description"><i class="fas fa-sticky-note"></i> البيان</label>
                            <textarea id="payment-description" rows="1" placeholder="وصف التحصيل..."></textarea>
                        </div>
                        <div class="form-group form-buttons">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التحصيل</button>
                        </div>
                    </div>
                </form>
                
                <div class="card mt-15">
                    <div class="card-header">بحث المدفوعات</div>
                    <div class="search-bar">
                        <div class="form-group">
                            <div class="search-container">
                                <input type="text" id="search-payment-customer" class="input-customer customer-search-input" placeholder="ابحث عن العميل...">
                                <div class="search-results" id="search-payment-customer-results"></div>
                            </div>
                            <input type="hidden" id="search-payment-customer-id">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-info" id="search-payment-btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-secondary" id="reset-payment-search"><i class="fas fa-redo"></i> إعادة</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-15">
                    <h3><i class="fas fa-list"></i> المدفوعات المسجلة</h3>
                    <table id="payments-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>اسم العميل</th>
                                <th>الفرع</th>
                                <th>المبلغ</th>
                                <th>الخصم</th>
                                <th>رقم السند</th>
                                <th>طريقة الدفع</th>
                                <th>البيان</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- صفحة كشف حساب العميل -->
            <section id="statements" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-chart-line"></i> كشف حساب العميل</h2>
                    <div>
                        <button class="btn btn-success" id="save-pdf-btn"><i class="fas fa-file-pdf"></i> حفظ PDF</button>
                        <button class="btn btn-print" onclick="printStatement()"><i class="fas fa-print"></i> طباعة</button>
                    </div>
                </div>
                
                <form id="statement-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="statement-customer"><i class="fas fa-user-tie"></i> اسم العميل</label>
                            <div class="search-container">
                                <input type="text" id="statement-customer" class="input-customer-large customer-search-input" 
                                       placeholder="ابحث عن العميل..." required autocomplete="off">
                                <div class="search-results" id="statement-customer-results"></div>
                            </div>
                            <input type="hidden" id="statement-customer-id">
                        </div>
                        <div class="form-group">
                            <label for="statement-branch"><i class="fas fa-code-branch"></i> الفرع (اختياري)</label>
                            <div class="search-container">
                                <input type="text" id="statement-branch" class="input-branch customer-search-input" 
                                       placeholder="اختر فرعاً..." autocomplete="off">
                                <div class="search-results" id="statement-branch-results"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="start-date"><i class="fas fa-calendar-alt"></i> من تاريخ</label>
                            <input type="date" id="start-date" class="input-date" required>
                        </div>
                        <div class="form-group">
                            <label for="end-date"><i class="fas fa-calendar-alt"></i> إلى تاريخ</label>
                            <input type="date" id="end-date" class="input-date" required>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" style="margin-top: 24px;">
                                <i class="fas fa-eye"></i> عرض الكشف
                            </button>
                        </div>
                    </div>
                </form>

                <!-- نتائج كشف الحساب للعرض على الشاشة -->
                <div id="statement-results" class="statement-container hidden">
                    <div class="statement-header">
                        <div class="pdf-header-row">
                            <div class="pdf-logo-name">
                                <div class="pdf-logo">
                                    <img src="https://i.postimg.cc/rFmJ1c8z/logo.png" alt="شعار الشركة">
                                </div>
                                <h2>شركة مجموعة تامبا الذهبية</h2>
                            </div>
                            <h3>كشف حساب عميل</h3>
                            <div class="statement-info-row">
                                <div class="customer-name-large">اسم العميل: <span id="display-customer-name"></span></div>
                            </div>
                            <div class="statement-info-row">
                                <div class="branch-info">الفرع: <span id="display-branch-name"></span></div>
                            </div>
                            <div class="period-info">
                                <div>الفترة: من <span id="display-start-date"></span></div>
                                <div>إلى <span id="display-end-date"></span></div>
                                <div>تاريخ الطباعة: <span id="display-print-date"></span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="statement-summary" class="statement-summary">
                    </div>
                    
                    <table class="statement-table" id="statement-table">
                        <thead>
                            <tr>
                                <th width="12%">التاريخ</th>
                                <th width="7%">رقم الفاتورة</th>
                                <th width="8%">رقم السند</th>
                                <th width="8%">المندوب</th>
                                <th width="12%">الفرع</th>
                                <th width="38%">البيان</th>
                                <th width="8%">مدين</th>
                                <th width="8%">دائن</th>
                                <th width="8%">الرصيد</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot id="statement-totals" class="hidden">
                            <!-- سيتم إضافة صف الإجماليات هنا ديناميكياً -->
                        </tfoot>
                    </table>
                </div>
            </section>

            <!-- صفحة جميع العملاء -->
            <section id="all-customers" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-users"></i> إدارة العملاء</h2>
                </div>
                
                <div class="card">
                    <div class="card-header">إضافة عميل جديد</div>
                    <form id="new-customer-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-customer-name"><i class="fas fa-user-tie"></i> اسم العميل</label>
                                <input type="text" id="new-customer-name" class="input-customer-large" required>
                            </div>
                            <div class="form-group">
                                <label for="new-customer-branches"><i class="fas fa-code-branch"></i> الفروع (افصل بفواصل)</label>
                                <textarea id="new-customer-branches" class="textarea-small" placeholder="الفرع 1، الفرع 2، ..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="new-customer-contact"><i class="fas fa-phone"></i> معلومات الاتصال</label>
                                <textarea id="new-customer-contact" class="textarea-small"></textarea>
                            </div>
                            <div class="form-group form-buttons">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ العميل</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="card mt-15">
                    <div class="card-header">بحث العملاء</div>
                    <div class="search-bar">
                        <div class="form-group">
                            <input type="text" id="search-customer-name" class="input-customer" placeholder="ابحث باسم العميل...">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-info" id="search-customer-btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-secondary" id="reset-customer-search"><i class="fas fa-redo"></i> إعادة</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-15">
                    <h3><i class="fas fa-list"></i> جميع العملاء</h3>
                    <table id="customers-table">
                        <thead>
                            <tr>
                                <th>اسم العميل</th>
                                <th>الفروع</th>
                                <th>معلومات الاتصال</th>
                                <th>تاريخ الإضافة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- صفحة المندوبين -->
            <section id="salesmen" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-user-tie"></i> إدارة المندوبين</h2>
                </div>
                
                <div class="card">
                    <div class="card-header">إضافة مندوب جديد</div>
                    <form id="new-salesman-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-salesman-name"><i class="fas fa-user"></i> اسم المندوب</label>
                                <input type="text" id="new-salesman-name" class="input-customer-large" required>
                            </div>
                            <div class="form-group">
                                <label for="new-salesman-phone"><i class="fas fa-phone"></i> رقم الهاتف</label>
                                <input type="text" id="new-salesman-phone" class="input-customer" placeholder="رقم الهاتف">
                            </div>
                            <div class="form-group">
                                <label for="new-salesman-email"><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                                <input type="email" id="new-salesman-email" class="input-customer" placeholder="البريد الإلكتروني">
                            </div>
                            <div class="form-group form-buttons">
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ المندوب</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="card mt-15">
                    <div class="card-header">بحث المندوبين</div>
                    <div class="search-bar">
                        <div class="form-group">
                            <input type="text" id="search-salesman-name" class="input-customer" placeholder="ابحث باسم المندوب...">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-info" id="search-salesman-btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-secondary" id="reset-salesman-search"><i class="fas fa-redo"></i> إعادة</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-15">
                    <h3><i class="fas fa-list"></i> جميع المندوبين</h3>
                    <table id="salesmen-table" class="salesmen-table">
                        <thead>
                            <tr>
                                <th>اسم المندوب</th>
                                <th>رقم الهاتف</th>
                                <th>البريد الإلكتروني</th>
                                <th>تاريخ الإضافة</th>
                                <th>عدد الفواتير</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- صفحة الرصيد الافتتاحي -->
            <section id="opening-balances" class="page">
                <div class="page-header">
                    <h2 class="page-title"><i class="fas fa-balance-scale"></i> الرصيد الافتتاحي للعملاء</h2>
                </div>
                
                <form id="opening-balance-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="balance-customer"><i class="fas fa-user-tie"></i> اسم العميل</label>
                            <div class="search-container">
                                <input type="text" id="balance-customer" class="input-customer-large customer-search-input" 
                                       placeholder="ابحث عن العميل..." required autocomplete="off">
                                <div class="search-results" id="balance-customer-results"></div>
                            </div>
                            <input type="hidden" id="balance-customer-id">
                        </div>
                        <div class="form-group">
                            <label for="balance-branch"><i class="fas fa-code-branch"></i> الفرع</label>
                            <div class="search-container">
                                <input type="text" id="balance-branch" class="input-branch customer-search-input" 
                                       placeholder="اختر فرعاً..." required autocomplete="off">
                                <div class="search-results" id="balance-branch-results"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="balance-date"><i class="fas fa-calendar-alt"></i> التاريخ</label>
                            <input type="date" id="balance-date" class="input-date" required>
                        </div>
                        <div class="form-group">
                            <label for="opening-balance"><i class="fas fa-money-bill"></i> رصيد أول المدة</label>
                            <input type="number" id="opening-balance" class="input-amount" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group form-buttons">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ الرصيد</button>
                        </div>
                    </div>
                </form>
                
                <div class="mt-15">
                    <h3><i class="fas fa-list"></i> الارصدة الافتتاحية المسجلة</h3>
                    <table id="balances-table">
                        <thead>
                            <tr>
                                <th>اسم العميل</th>
                                <th>الفرع</th>
                                <th>التاريخ</th>
                                <th>الرصيد</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal لتعديل الفاتورة -->
    <div id="edit-invoice-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> تعديل الفاتورة</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-invoice-form">
                <input type="hidden" id="edit-invoice-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-invoice-date">تاريخ الفاتورة</label>
                        <input type="date" id="edit-invoice-date" class="input-date" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-invoice-customer">اسم العميل</label>
                        <div class="search-container">
                            <input type="text" id="edit-invoice-customer" class="input-customer-large customer-search-input" 
                                   placeholder="ابحث عن العميل..." required autocomplete="off">
                            <div class="search-results" id="edit-invoice-customer-results"></div>
                        </div>
                        <input type="hidden" id="edit-invoice-customer-id">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-invoice-branch">الفرع</label>
                        <div class="search-container">
                            <input type="text" id="edit-invoice-branch" class="input-branch customer-search-input" 
                                   placeholder="اختر فرعاً..." autocomplete="off">
                            <div class="search-results" id="edit-invoice-branch-results"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-invoice-number">رقم الفاتورة</label>
                        <input type="text" id="edit-invoice-number" class="input-small">
                    </div>
                    <div class="form-group">
                        <label for="edit-invoice-salesman">المندوب</label>
                        <div class="search-container">
                            <input type="text" id="edit-invoice-salesman" class="input-salesman customer-search-input" 
                                   placeholder="اختر مندوباً..." required autocomplete="off">
                            <div class="search-results" id="edit-invoice-salesman-results"></div>
                        </div>
                        <input type="hidden" id="edit-invoice-salesman-id">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-invoice-amount">قيمة الفاتورة</label>
                        <input type="number" id="edit-invoice-amount" class="input-amount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="edit-invoice-description">البيـــــان</label>
                        <textarea id="edit-invoice-description" rows="1"></textarea>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التعديلات</button>
                    <button type="button" class="btn btn-secondary close-modal"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal لتعديل التحصيل -->
    <div id="edit-payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> تعديل سند التحصيل</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-payment-form">
                <input type="hidden" id="edit-payment-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-payment-date">تاريخ التحصيل</label>
                        <input type="date" id="edit-payment-date" class="input-date" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-payment-customer">اسم العميل</label>
                        <div class="search-container">
                            <input type="text" id="edit-payment-customer" class="input-customer-large customer-search-input" 
                                   placeholder="ابحث عن العميل..." required autocomplete="off">
                            <div class="search-results" id="edit-payment-customer-results"></div>
                        </div>
                        <input type="hidden" id="edit-payment-customer-id">
                    </div>
                    <div class="form-group">
                        <label for="edit-payment-branch">الفرع</label>
                        <div class="search-container">
                            <input type="text" id="edit-payment-branch" class="input-branch customer-search-input" 
                                   placeholder="اختر فرعاً..." autocomplete="off">
                            <div class="search-results" id="edit-payment-branch-results"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-money-check"></i> طريقة الدفع</label>
                        <div class="payment-type-container">
                            <button type="button" class="payment-type-btn active" data-type="cash">نقدي</button>
                            <button type="button" class="payment-type-btn" data-type="check">شيك</button>
                        </div>
                        <input type="hidden" id="edit-payment-type" value="cash">
                    </div>
                    <div class="form-group">
                        <label for="edit-payment-voucher">رقم السند</label>
                        <input type="text" id="edit-payment-voucher" class="input-voucher">
                    </div>
                    <div class="form-group">
                        <label for="edit-payment-amount">المبلغ المسدد</label>
                        <input type="number" id="edit-payment-amount" class="input-amount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-discount-amount">الخصم (مبلغ)</label>
                        <input type="number" id="edit-discount-amount" class="input-discount" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                
                <!-- Check Details (Hidden by Default) -->
                <div id="edit-check-details" class="payment-details" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-check-number"><i class="fas fa-hashtag"></i> رقم الشيك</label>
                            <input type="text" id="edit-check-number" class="input-medium">
                        </div>
                        <div class="form-group">
                            <label for="edit-bank-name"><i class="fas fa-university"></i> اسم البنك</label>
                            <input type="text" id="edit-bank-name" class="input-medium">
                        </div>
                        <div class="form-group">
                            <label for="edit-check-date"><i class="fas fa-calendar-alt"></i> تاريخ الشيك</label>
                            <input type="date" id="edit-check-date" class="input-date">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="edit-payment-description">البيان</label>
                        <textarea id="edit-payment-description" rows="1"></textarea>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التعديلات</button>
                    <button type="button" class="btn btn-secondary close-modal"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal لتعديل العميل -->
    <div id="edit-customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> تعديل بيانات العميل</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-customer-form">
                <input type="hidden" id="edit-customer-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-customer-name">اسم العميل</label>
                        <input type="text" id="edit-customer-name" class="input-customer-large" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-customer-branches">الفروع (افصل بفواصل)</label>
                        <textarea id="edit-customer-branches" class="textarea-small"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-customer-contact">معلومات الاتصال</label>
                        <textarea id="edit-customer-contact" class="textarea-small"></textarea>
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التعديلات</button>
                    <button type="button" class="btn btn-secondary close-modal"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal لتعديل المندوب -->
    <div id="edit-salesman-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> تعديل بيانات المندوب</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-salesman-form">
                <input type="hidden" id="edit-salesman-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-salesman-name">اسم المندوب</label>
                        <input type="text" id="edit-salesman-name" class="input-customer-large" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-salesman-phone">رقم الهاتف</label>
                        <input type="text" id="edit-salesman-phone" class="input-customer">
                    </div>
                    <div class="form-group">
                        <label for="edit-salesman-email">البريد الإلكتروني</label>
                        <input type="email" id="edit-salesman-email" class="input-customer">
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التعديلات</button>
                    <button type="button" class="btn btn-secondary close-modal"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal لتعديل الرصيد الافتتاحي -->
    <div id="edit-balance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> تعديل الرصيد الافتتاحي</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-balance-form">
                <input type="hidden" id="edit-balance-id">
                <div class="form-group">
                    <label for="edit-balance-customer">اسم العميل</label>
                    <div class="search-container">
                        <input type="text" id="edit-balance-customer" class="input-customer-large customer-search-input" 
                               placeholder="ابحث عن العميل..." required autocomplete="off">
                        <div class="search-results" id="edit-balance-customer-results"></div>
                    </div>
                    <input type="hidden" id="edit-balance-customer-id">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-balance-branch">الفرع</label>
                        <div class="search-container">
                            <input type="text" id="edit-balance-branch" class="input-branch customer-search-input" 
                                   placeholder="اختر فرعاً..." required autocomplete="off">
                            <div class="search-results" id="edit-balance-branch-results"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-balance-date">التاريخ</label>
                        <input type="date" id="edit-balance-date" class="input-date" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-opening-balance">رصيد أول المدة</label>
                        <input type="number" id="edit-opening-balance" class="input-amount" step="0.01" placeholder="0.00" required>
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التعديلات</button>
                    <button type="button" class="btn btn-secondary close-modal"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal لتعديل المرتجع -->
    <div id="edit-return-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> تعديل مرتجع المبيعات</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-return-form">
                <input type="hidden" id="edit-return-id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-return-date">تاريخ المرتجع</label>
                        <input type="date" id="edit-return-date" class="input-date" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-return-customer">اسم العميل</label>
                        <div class="search-container">
                            <input type="text" id="edit-return-customer" class="input-customer-large customer-search-input" 
                                   placeholder="ابحث عن العميل..." required autocomplete="off">
                            <div class="search-results" id="edit-return-customer-results"></div>
                        </div>
                        <input type="hidden" id="edit-return-customer-id">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-return-branch">الفرع</label>
                        <div class="search-container">
                            <input type="text" id="edit-return-branch" class="input-branch customer-search-input" 
                                   placeholder="اختر فرعاً..." autocomplete="off">
                            <div class="search-results" id="edit-return-branch-results"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-return-number">رقم المرتجع</label>
                        <input type="text" id="edit-return-number" class="input-small">
                    </div>
                    <div class="form-group">
                        <label for="edit-return-salesman">المندوب</label>
                        <div class="search-container">
                            <input type="text" id="edit-return-salesman" class="input-salesman customer-search-input" 
                                   placeholder="اختر مندوباً..." required autocomplete="off">
                            <div class="search-results" id="edit-return-salesman-results"></div>
                        </div>
                        <input type="hidden" id="edit-return-salesman-id">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-return-amount">قيمة المرتجع</label>
                        <input type="number" id="edit-return-amount" class="input-amount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label for="edit-return-description">السبب</label>
                        <textarea id="edit-return-description" rows="1"></textarea>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> حفظ التعديلات</button>
                    <button type="button" class="btn btn-secondary close-modal"><i class="fas fa-times"></i> إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- قالب PDF منفصل -->
    <div id="pdf-template" class="pdf-template">
        <div class="pdf-header">
            <div class="pdf-header-row">
                <div class="pdf-logo-name" style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; gap: 15px;">
                    <div class="pdf-logo" style="margin: 0;">
                        <img src="https://i.postimg.cc/rFmJ1c8z/logo.png" alt="شعار الشركة" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #4a90e2;">
                    </div>
                    <h2 style="color: #4a90e2; margin: 0; font-size: 22px;">شركة مجموعة تامبا الذهبية</h2>
                </div>
                <h3 style="color: #4a90e2; margin: 0 0 20px 0; font-size: 20px;">كشف حساب عميل</h3>
                <div class="statement-info-row" style="margin-bottom: 15px;">
                    <div style="font-size: 20px; font-weight: bold;">اسم العميل: <span id="pdf-customer-name"></span></div>
                </div>
                <div class="statement-info-row" style="margin-bottom: 15px;">
                    <div style="font-size: 18px;">الفرع: <span id="pdf-branch-name"></span></div>
                </div>
                <div class="period-info" style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 16px;">
                    <div>الفترة: من <span id="pdf-start-date"></span></div>
                    <div>إلى <span id="pdf-end-date"></span></div>
                    <div>تاريخ الطباعة: <span id="pdf-print-date"></span></div>
                </div>
            </div>
        </div>
        
        <div id="pdf-summary">
        </div>
        
        <table class="statement-table" id="pdf-statement-table" style="font-size: 12px;">
            <thead>
                <tr>
                    <th width="12%">التاريخ</th>
                    <th width="7%">رقم الفاتورة</th>
                    <th width="8%">رقم السند</th>
                    <th width="8%">المندوب</th>
                    <th width="12%">الفرع</th>
                    <th width="38%">البيان</th>
                    <th width="8%">مدين</th>
                    <th width="8%">دائن</th>
                    <th width="8%">الرصيد</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot id="pdf-totals">
                <!-- سيتم إضافة صف الإجماليات هنا ديناميكياً -->
            </tfoot>
        </table>
    </div>

    <footer>
        <div class="container">
            <p>نظام متابعة العملاء - <span id="footer-company-name">شركة مجموعة تامبا الذهبية</span> &copy; <span id="current-year"></span></p>
        </div>
    </footer>

    <script>
        // البيانات الأساسية
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let salesmen = JSON.parse(localStorage.getItem('salesmen')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let returns = JSON.parse(localStorage.getItem('returns')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        let openingBalances = JSON.parse(localStorage.getItem('openingBalances')) || [];
        
        // تهيئة التواريخ
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين تاريخ اليوم في حقول التاريخ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            document.getElementById('return-date').value = today;
            document.getElementById('payment-date').value = today;
            document.getElementById('balance-date').value = today;
            
            // تعيين تاريخ أول الشهر الحالي وتاريخ اليوم في كشف الحساب
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('start-date').value = firstDayOfMonth;
            document.getElementById('end-date').value = today;
            
            // تعيين السنة الحالية في التذييل
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // تحميل البيانات
            loadCustomers();
            loadSalesmen();
            loadInvoices();
            loadReturns();
            loadPayments();
            loadOpeningBalances();
            
            // إضافة مستمعي الأحداث
            setupEventListeners();
            
            // إعداد خيارات الخصم
            setupDiscountOptions();
            
            // إعداد طريقة الدفع
            setupPaymentType();
            
            // تحديث إحصائيات المبيعات والتحصيلات
            updateSalesStats();
            updatePaymentsStats();
        });
        
        // إعداد خيارات الخصم
        function setupDiscountOptions() {
            const discountButtons = document.querySelectorAll('.discount-type-btn');
            discountButtons.forEach(button => {
                button.addEventListener('click', function() {
                    discountButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const discountType = this.dataset.type;
                    document.getElementById('discount-type').value = discountType;
                    
                    if (discountType === 'percentage') {
                        document.getElementById('discount-percentage').style.display = 'block';
                        document.getElementById('discount-amount').style.display = 'none';
                    } else {
                        document.getElementById('discount-percentage').style.display = 'none';
                        document.getElementById('discount-amount').style.display = 'block';
                    }
                });
            });
        }
        
        // إعداد طريقة الدفع
        function setupPaymentType() {
            const paymentButtons = document.querySelectorAll('.payment-type-btn');
            paymentButtons.forEach(button => {
                button.addEventListener('click', function() {
                    paymentButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const paymentType = this.dataset.type;
                    document.getElementById('payment-type').value = paymentType;
                    
                    if (paymentType === 'check') {
                        document.getElementById('check-details').style.display = 'block';
                    } else {
                        document.getElementById('check-details').style.display = 'none';
                    }
                });
            });
        }
        
        // إعداد البحث الديناميكي
        function setupSearch() {
            setupCustomerSearch();
            setupSalesmanSearch();
            setupBranchSearch();
        }
        
        // إعداد البحث الديناميكي للعملاء
        function setupCustomerSearch() {
            const searchInputs = [
                'invoice-customer',
                'return-customer',
                'payment-customer',
                'statement-customer',
                'balance-customer',
                'edit-invoice-customer',
                'edit-return-customer',
                'edit-payment-customer',
                'edit-balance-customer',
                'search-invoice-customer',
                'search-return-customer',
                'search-payment-customer'
            ];
            
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const hiddenInput = document.getElementById(inputId + '-id');
                const resultsContainer = document.getElementById(inputId + '-results');
                
                if (input) {
                    input.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.trim();
                        
                        if (searchTerm.length === 0) {
                            resultsContainer.style.display = 'none';
                            if (hiddenInput) hiddenInput.value = '';
                            return;
                        }
                        
                        // تصفية العملاء بناءً على البحث
                        const filteredCustomers = customers.filter(customer => 
                            customer.name.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                        
                        // عرض النتائج
                        if (filteredCustomers.length > 0) {
                            resultsContainer.innerHTML = '';
                            filteredCustomers.forEach(customer => {
                                const item = document.createElement('div');
                                item.className = 'search-result-item';
                                item.textContent = customer.name;
                                item.dataset.customerId = customer.id;
                                item.dataset.customerName = customer.name;
                                
                                item.addEventListener('click', function() {
                                    input.value = this.dataset.customerName;
                                    if (hiddenInput) hiddenInput.value = this.dataset.customerId;
                                    resultsContainer.style.display = 'none';
                                    
                                    // إذا كان حقل الرصيد الحالي موجوداً، قم بتحديثه
                                    if (inputId === 'payment-customer') {
                                        updateCurrentBalance();
                                    }
                                    
                                    // إذا كان حقل الفروع موجوداً، قم بتحديث قائمة الفروع
                                    if (inputId.startsWith('invoice') || inputId.startsWith('return') || 
                                        inputId.startsWith('payment') || inputId.startsWith('balance') || 
                                        inputId.startsWith('edit-')) {
                                        updateBranchesForCustomer(this.dataset.customerId, inputId.replace('customer', 'branch'));
                                    }
                                });
                                
                                resultsContainer.appendChild(item);
                            });
                            resultsContainer.style.display = 'block';
                        } else {
                            resultsContainer.style.display = 'none';
                        }
                    });
                    
                    // إخفاء النتائج عند النقر خارجها
                    document.addEventListener('click', function(e) {
                        if (!input.contains(e.target) && !resultsContainer.contains(e.target)) {
                            resultsContainer.style.display = 'none';
                        }
                    });
                }
            });
        }
        
        // إعداد البحث الديناميكي للمندوبين
        function setupSalesmanSearch() {
            const searchInputs = [
                'invoice-salesman',
                'return-salesman',
                'edit-invoice-salesman',
                'edit-return-salesman'
            ];
            
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const hiddenInput = document.getElementById(inputId + '-id');
                const resultsContainer = document.getElementById(inputId + '-results');
                
                if (input) {
                    input.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.trim();
                        
                        if (searchTerm.length === 0) {
                            resultsContainer.style.display = 'none';
                            if (hiddenInput) hiddenInput.value = '';
                            return;
                        }
                        
                        // تصفية المندوبين بناءً على البحث
                        const filteredSalesmen = salesmen.filter(salesman => 
                            salesman.name.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                        
                        // عرض النتائج
                        if (filteredSalesmen.length > 0) {
                            resultsContainer.innerHTML = '';
                            filteredSalesmen.forEach(salesman => {
                                const item = document.createElement('div');
                                item.className = 'search-result-item';
                                item.textContent = salesman.name;
                                item.dataset.salesmanId = salesman.id;
                                item.dataset.salesmanName = salesman.name;
                                
                                item.addEventListener('click', function() {
                                    input.value = this.dataset.salesmanName;
                                    if (hiddenInput) hiddenInput.value = this.dataset.salesmanId;
                                    resultsContainer.style.display = 'none';
                                });
                                
                                resultsContainer.appendChild(item);
                            });
                            resultsContainer.style.display = 'block';
                        } else {
                            resultsContainer.style.display = 'none';
                        }
                    });
                    
                    // إخفاء النتائج عند النقر خارجها
                    document.addEventListener('click', function(e) {
                        if (!input.contains(e.target) && !resultsContainer.contains(e.target)) {
                            resultsContainer.style.display = 'none';
                        }
                    });
                }
            });
        }
        
        // إعداد البحث الديناميكي للفروع
        function setupBranchSearch() {
            const branchInputs = [
                'invoice-branch',
                'return-branch',
                'payment-branch',
                'statement-branch',
                'balance-branch',
                'edit-invoice-branch',
                'edit-return-branch',
                'edit-payment-branch',
                'edit-balance-branch'
            ];
            
            branchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                const resultsContainer = document.getElementById(inputId + '-results');
                
                if (input) {
                    input.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.trim();
                        
                        if (searchTerm.length === 0) {
                            resultsContainer.style.display = 'none';
                            return;
                        }
                        
                        // الحصول على العملاء المرتبطين
                        const customerId = document.getElementById(inputId.replace('branch', 'customer-id'))?.value;
                        let availableBranches = [];
                        
                        if (customerId) {
                            const customer = customers.find(c => c.id === customerId);
                            if (customer && customer.branches) {
                                availableBranches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                            }
                        }
                        
                        // تصفية الفروع بناءً على البحث
                        const filteredBranches = availableBranches.filter(branch => 
                            branch.toLowerCase().includes(searchTerm.toLowerCase())
                        );
                        
                        // عرض النتائج
                        if (filteredBranches.length > 0) {
                            resultsContainer.innerHTML = '';
                            filteredBranches.forEach(branch => {
                                const item = document.createElement('div');
                                item.className = 'search-result-item';
                                item.textContent = branch;
                                item.dataset.branchName = branch;
                                
                                item.addEventListener('click', function() {
                                    input.value = this.dataset.branchName;
                                    resultsContainer.style.display = 'none';
                                });
                                
                                resultsContainer.appendChild(item);
                            });
                            resultsContainer.style.display = 'block';
                        } else {
                            resultsContainer.style.display = 'none';
                        }
                    });
                    
                    // إخفاء النتائج عند النقر خارجها
                    document.addEventListener('click', function(e) {
                        if (!input.contains(e.target) && !resultsContainer.contains(e.target)) {
                            resultsContainer.style.display = 'none';
                        }
                    });
                }
            });
        }
        
        // تحديث الفروع لعملاء محددين
        function updateBranchesForCustomer(customerId, branchInputId) {
            if (!customerId) return;
            
            const customer = customers.find(c => c.id === customerId);
            const branchInput = document.getElementById(branchInputId);
            
            if (!customer || !branchInput) return;
            
            // تحديث قائمة البحث الديناميكي
            if (customer.branches) {
                const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                
                // إذا كان هناك فرع واحد فقط، قم بتعيينه تلقائياً
                if (branches.length === 1) {
                    branchInput.value = branches[0];
                } else {
                    branchInput.value = '';
                }
            } else {
                branchInput.value = '';
            }
        }
        
        // تحديث الرصيد الحالي للعميل
        function updateCurrentBalance() {
            const customerId = document.getElementById('payment-customer-id').value;
            if (!customerId) {
                document.getElementById('current-balance').value = '0.00';
                return;
            }
            
            const balance = calculateCustomerBalance(customerId);
            document.getElementById('current-balance').value = formatCurrency(balance);
        }
        
        // حساب الرصيد الحالي للعميل
        function calculateCustomerBalance(customerId, branch = null) {
            // الحصول على الرصيد الافتتاحي
            let openingBalance = 0;
            if (branch) {
                const branchBalances = openingBalances.filter(b => 
                    b.customerId === customerId && b.branch === branch
                );
                if (branchBalances.length > 0) {
                    openingBalance = branchBalances.reduce((sum, b) => sum + b.balance, 0);
                }
            } else {
                const customerBalances = openingBalances.filter(b => b.customerId === customerId);
                openingBalance = customerBalances.reduce((sum, b) => sum + b.balance, 0);
            }
            
            let currentBalance = openingBalance;
            
            // جمع الفواتير
            let customerInvoices;
            if (branch) {
                customerInvoices = invoices.filter(inv => 
                    inv.customerId === customerId && inv.branch === branch
                );
            } else {
                customerInvoices = invoices.filter(inv => inv.customerId === customerId);
            }
            customerInvoices.forEach(invoice => {
                currentBalance += invoice.amount;
            });
            
            // جمع المرتجعات (تقلل الرصيد لأنها دائنة)
            let customerReturns;
            if (branch) {
                customerReturns = returns.filter(ret => 
                    ret.customerId === customerId && ret.branch === branch
                );
            } else {
                customerReturns = returns.filter(ret => ret.customerId === customerId);
            }
            customerReturns.forEach(ret => {
                currentBalance -= ret.amount; // المرتجعات تقلل الرصيد
            });
            
            // جمع المدفوعات
            let customerPayments;
            if (branch) {
                customerPayments = payments.filter(pay => 
                    pay.customerId === customerId && pay.branch === branch
                );
            } else {
                customerPayments = payments.filter(pay => pay.customerId === customerId);
            }
            customerPayments.forEach(payment => {
                currentBalance -= payment.amount;
                if (payment.discount) {
                    currentBalance -= payment.discount;
                }
            });
            
            return currentBalance;
        }
        
        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // التنقل بين الصفحات
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                    
                    // تحديث حالة التنشيط
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // إضافة عميل جديد
            document.getElementById('add-customer-btn').addEventListener('click', function() {
                showPage('all-customers');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector('[data-page="all-customers"]').classList.add('active');
            });
            
            // إغلاق النوافذ المنبثقة
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.classList.remove('active');
                    });
                });
            });
            
            // حفظ الفاتورة
            document.getElementById('invoice-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInvoice();
            });
            
            // حفظ المرتجع
            document.getElementById('return-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveReturn();
            });
            
            // حفظ التحصيل
            document.getElementById('payment-form').addEventListener('submit', function(e) {
                e.preventDefault();
                savePayment();
            });
            
            // حفظ الرصيد الافتتاحي
            document.getElementById('opening-balance-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveOpeningBalance();
            });
            
            // عرض كشف الحساب
            document.getElementById('statement-form').addEventListener('submit', function(e) {
                e.preventDefault();
                generateStatement();
            });
            
            // إضافة عميل جديد
            document.getElementById('new-customer-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewCustomer();
            });
            
            // إضافة مندوب جديد
            document.getElementById('new-salesman-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewSalesman();
            });
            
            // تعديل الفاتورة
            document.getElementById('edit-invoice-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateInvoice();
            });
            
            // تعديل المرتجع
            document.getElementById('edit-return-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateReturn();
            });
            
            // تعديل التحصيل
            document.getElementById('edit-payment-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updatePayment();
            });
            
            // تعديل العميل
            document.getElementById('edit-customer-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateCustomer();
            });
            
            // تعديل المندوب
            document.getElementById('edit-salesman-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateSalesman();
            });
            
            // تعديل الرصيد الافتتاحي
            document.getElementById('edit-balance-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateOpeningBalance();
            });
            
            // البحث في الفواتير
            document.getElementById('search-invoice-btn').addEventListener('click', searchInvoices);
            document.getElementById('reset-invoice-search').addEventListener('click', resetInvoiceSearch);
            
            // البحث في المرتجعات
            document.getElementById('search-return-btn').addEventListener('click', searchReturns);
            document.getElementById('reset-return-search').addEventListener('click', resetReturnSearch);
            
            // البحث في المدفوعات
            document.getElementById('search-payment-btn').addEventListener('click', searchPayments);
            document.getElementById('reset-payment-search').addEventListener('click', resetPaymentSearch);
            
            // البحث في العملاء
            document.getElementById('search-customer-btn').addEventListener('click', searchCustomers);
            document.getElementById('reset-customer-search').addEventListener('click', resetCustomerSearch);
            
            // البحث في المندوبين
            document.getElementById('search-salesman-btn').addEventListener('click', searchSalesmen);
            document.getElementById('reset-salesman-search').addEventListener('click', resetSalesmanSearch);
            
            // حفظ PDF
            document.getElementById('save-pdf-btn').addEventListener('click', saveAsPDF);
            
            // تحديث الرصيد الحالي عند اختيار عميل في شاشة التحصيل
            document.getElementById('payment-customer').addEventListener('input', function() {
                // سيتم تحديث الرصيد عند اختيار عميل من القائمة
            });
            
            // إعداد البحث الديناميكي
            setupSearch();
            
            // تصدير الفواتير إلى Excel
            document.getElementById('export-invoices').addEventListener('click', function() {
                exportToExcel('invoices-table', 'فواتير_المسجلة.xlsx');
            });
            
            // تصدير المرتجعات إلى Excel
            document.getElementById('export-returns').addEventListener('click', function() {
                exportToExcel('returns-table', 'مرتجعات_المسجلة.xlsx');
            });
        }
        
        // عرض صفحة محددة
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        // تحميل العملاء
        function loadCustomers() {
            const tableBody = document.querySelector('#customers-table tbody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                customers.forEach(customer => {
                    const branches = customer.branches ? customer.branches.split(',').map(b => b.trim()).filter(b => b) : [];
                    const branchesDisplay = branches.map(branch => 
                        `<span class="branch-tag">${branch}</span>`
                    ).join(' ');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.name}</td>
                        <td>${branchesDisplay || '-'}</td>
                        <td>${customer.contact || '-'}</td>
                        <td>${formatDate(customer.createdAt)}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editCustomer('${customer.id}')"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer.id}')"><i class="fas fa-trash"></i> حذف</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        // تحميل المندوبين
        function loadSalesmen() {
            const tableBody = document.querySelector('#salesmen-table tbody');
            if (tableBody) {
                tableBody.innerHTML = '';
                
                salesmen.forEach(salesman => {
                    // حساب عدد الفواتير لهذا المندوب
                    const invoiceCount = invoices.filter(inv => 
                        inv.salesmanId === salesman.id || inv.salesman === salesman.name
                    ).length;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${salesman.name}</td>
                        <td>${salesman.phone || '-'}</td>
                        <td>${salesman.email || '-'}</td>
                        <td>${formatDate(salesman.createdAt)}</td>
                        <td>${invoiceCount}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editSalesman('${salesman.id}')"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSalesman('${salesman.id}')"><i class="fas fa-trash"></i> حذف</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        // حفظ عميل جديد
        function saveNewCustomer() {
            try {
                const name = document.getElementById('new-customer-name').value.trim();
                const branches = document.getElementById('new-customer-branches').value.trim();
                const contact = document.getElementById('new-customer-contact').value.trim();
                
                if (!name) {
                    alert('يرجى إدخال اسم العميل');
                    return;
                }
                
                // التحقق من عدم تكرار اسم العميل
                const existingCustomer = customers.find(c => c.name.toLowerCase() === name.toLowerCase());
                if (existingCustomer) {
                    // إذا كان العميل موجوداً، إضافة فروع جديدة فقط
                    if (confirm('هذا العميل مسجل مسبقاً. هل تريد إضافة الفروع الجديدة إلى هذا العميل؟')) {
                        if (branches) {
                            const existingBranches = existingCustomer.branches ? existingCustomer.branches.split(',').map(b => b.trim()) : [];
                            const newBranches = branches.split(',').map(b => b.trim()).filter(b => b);
                            
                            // إضافة الفروع الجديدة فقط
                            newBranches.forEach(newBranch => {
                                if (!existingBranches.includes(newBranch)) {
                                    existingBranches.push(newBranch);
                                }
                            });
                            
                            existingCustomer.branches = existingBranches.join(', ');
                            
                            // تحديث معلومات الاتصال إذا تم تقديمها
                            if (contact) {
                                existingCustomer.contact = contact;
                            }
                            
                            localStorage.setItem('customers', JSON.stringify(customers));
                            loadCustomers();
                            document.getElementById('new-customer-form').reset();
                            alert('تم تحديث بيانات العميل بنجاح');
                            return;
                        }
                    }
                    return;
                }
                
                const newCustomer = {
                    id: Date.now().toString(),
                    name: name,
                    branches: branches,
                    contact: contact,
                    createdAt: new Date().toISOString()
                };
                
                customers.push(newCustomer);
                localStorage.setItem('customers', JSON.stringify(customers));
                
                document.getElementById('new-customer-form').reset();
                loadCustomers();
                alert('تم إضافة العميل بنجاح');
            } catch (error) {
                console.error('Error saving customer:', error);
                alert('حدث خطأ أثناء حفظ العميل: ' + error.message);
            }
        }
        
        // حفظ مندوب جديد
        function saveNewSalesman() {
            try {
                const name = document.getElementById('new-salesman-name').value.trim();
                const phone = document.getElementById('new-salesman-phone').value.trim();
                const email = document.getElementById('new-salesman-email').value.trim();
                
                if (!name) {
                    alert('يرجى إدخال اسم المندوب');
                    return;
                }
                
                // التحقق من عدم تكرار اسم المندوب
                if (salesmen.some(s => s.name.toLowerCase() === name.toLowerCase())) {
                    alert('هذا المندوب مسجل مسبقاً');
                    return;
                }
                
                const newSalesman = {
                    id: Date.now().toString(),
                    name: name,
                    phone: phone,
                    email: email,
                    createdAt: new Date().toISOString()
                };
                
                salesmen.push(newSalesman);
                localStorage.setItem('salesmen', JSON.stringify(salesmen));
                
                document.getElementById('new-salesman-form').reset();
                loadSalesmen();
                alert('تم إضافة المندوب بنجاح');
            } catch (error) {
                console.error('Error saving salesman:', error);
                alert('حدث خطأ أثناء حفظ المندوب: ' + error.message);
            }
        }
        
        // تعديل العميل
        function editCustomer(id) {
            const customer = customers.find(s => s.id === id);
            if (!customer) return;
            
            document.getElementById('edit-customer-id').value = customer.id;
            document.getElementById('edit-customer-name').value = customer.name;
            document.getElementById('edit-customer-branches').value = customer.branches || '';
            document.getElementById('edit-customer-contact').value = customer.contact || '';
            
            document.getElementById('edit-customer-modal').classList.add('active');
        }
        
        function updateCustomer() {
            try {
                const id = document.getElementById('edit-customer-id').value;
                const name = document.getElementById('edit-customer-name').value.trim();
                const branches = document.getElementById('edit-customer-branches').value.trim();
                const contact = document.getElementById('edit-customer-contact').value.trim();
                
                if (!name) {
                    alert('يرجى إدخال اسم العميل');
                    return;
                }
                
                const customerIndex = customers.findIndex(s => s.id === id);
                if (customerIndex === -1) return;
                
                // التحقق من عدم تكرار اسم العميل (باستثناء العميل الحالي)
                if (customers.some((s, index) => index !== customerIndex && s.name.toLowerCase() === name.toLowerCase())) {
                    alert('هذا الاسم مسجل لعميل آخر');
                    return;
                }
                
                customers[customerIndex].name = name;
                customers[customerIndex].branches = branches;
                customers[customerIndex].contact = contact;
                
                localStorage.setItem('customers', JSON.stringify(customers));
                
                document.getElementById('edit-customer-modal').classList.remove('active');
                loadCustomers();
                alert('تم تعديل بيانات العميل بنجاح');
            } catch (error) {
                console.error('Error updating customer:', error);
                alert('حدث خطأ أثناء تعديل العميل: ' + error.message);
            }
        }
        
        // تعديل المندوب
        function editSalesman(id) {
            const salesman = salesmen.find(s => s.id === id);
            if (!salesman) return;
            
            document.getElementById('edit-salesman-id').value = salesman.id;
            document.getElementById('edit-salesman-name').value = salesman.name;
            document.getElementById('edit-salesman-phone').value = salesman.phone || '';
            document.getElementById('edit-salesman-email').value = salesman.email || '';
            
            document.getElementById('edit-salesman-modal').classList.add('active');
        }
        
        function updateSalesman() {
            try {
                const id = document.getElementById('edit-salesman-id').value;
                const name = document.getElementById('edit-salesman-name').value.trim();
                const phone = document.getElementById('edit-salesman-phone').value.trim();
                const email = document.getElementById('edit-salesman-email').value.trim();
                
                if (!name) {
                    alert('يرجى إدخال اسم المندوب');
                    return;
                }
                
                const salesmanIndex = salesmen.findIndex(s => s.id === id);
                if (salesmanIndex === -1) return;
                
                // التحقق من عدم تكرار اسم المندوب (باستثناء المندوب الحالي)
                if (salesmen.some((s, index) => index !== salesmanIndex && s.name.toLowerCase() === name.toLowerCase())) {
                    alert('هذا الاسم مسجل لمندوب آخر');
                    return;
                }
                
                salesmen[salesmanIndex].name = name;
                salesmen[salesmanIndex].phone = phone;
                salesmen[salesmanIndex].email = email;
                
                localStorage.setItem('salesmen', JSON.stringify(salesmen));
                
                document.getElementById('edit-salesman-modal').classList.remove('active');
                loadSalesmen();
                alert('تم تعديل بيانات المندوب بنجاح');
            } catch (error) {
                console.error('Error updating salesman:', error);
                alert('حدث خطأ أثناء تعديل المندوب: ' + error.message);
            }
        }
        
        // حذف العميل
        function deleteCustomer(id) {
            if (!confirm('هل أنت متأكد من حذف هذا العميل؟ سيتم حذف جميع الفواتير والمرتجعات والمدفوعات المرتبطة به.')) {
                return;
            }
            
            try {
                // حذف الفواتير المرتبطة
                invoices = invoices.filter(invoice => invoice.customerId !== id);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                
                // حذف المرتجعات المرتبطة
                returns = returns.filter(ret => ret.customerId !== id);
                localStorage.setItem('returns', JSON.stringify(returns));
                
                // حذف المدفوعات المرتبطة
                payments = payments.filter(payment => payment.customerId !== id);
                localStorage.setItem('payments', JSON.stringify(payments));
                
                // حذف الرصيد الافتتاحي
                openingBalances = openingBalances.filter(balance => balance.customerId !== id);
                localStorage.setItem('openingBalances', JSON.stringify(openingBalances));
                
                // حذف العميل
                customers = customers.filter(customer => customer.id !== id);
                localStorage.setItem('customers', JSON.stringify(customers));
                
                loadCustomers();
                loadInvoices();
                loadReturns();
                loadPayments();
                loadOpeningBalances();
                updateSalesStats();
                updatePaymentsStats();
                
                alert('تم حذف العميل وجميع بياناته المرتبطة بنجاح');
            } catch (error) {
                console.error('Error deleting customer:', error);
                alert('حدث خطأ أثناء حذف العميل: ' + error.message);
            }
        }
        
        // حذف المندوب
        function deleteSalesman(id) {
            if (!confirm('هل أنت متأكد من حذف هذا المندوب؟ سيتم إزالة اسمه من الفواتير المرتبطة.')) {
                return;
            }
            
            try {
                // إزالة المندوب من الفواتير المرتبطة
                invoices.forEach(invoice => {
                    if (invoice.salesmanId === id) {
                        invoice.salesmanId = '';
                        invoice.salesman = '';
                    }
                });
                localStorage.setItem('invoices', JSON.stringify(invoices));
                
                // إزالة المندوب من المرتجعات المرتبطة
                returns.forEach(ret => {
                    if (ret.salesmanId === id) {
                        ret.salesmanId = '';
                        ret.salesman = '';
                    }
                });
                localStorage.setItem('returns', JSON.stringify(returns));
                
                // حذف المندوب
                salesmen = salesmen.filter(salesman => salesman.id !== id);
                localStorage.setItem('salesmen', JSON.stringify(salesmen));
                
                loadSalesmen();
                loadInvoices();
                loadReturns();
                updateSalesStats();
                
                alert('تم حذف المندوب بنجاح');
            } catch (error) {
                console.error('Error deleting salesman:', error);
                alert('حدث خطأ أثناء حذف المندوب: ' + error.message);
            }
        }
        
        // حفظ الفاتورة
        function saveInvoice() {
            try {
                const date = document.getElementById('invoice-date').value;
                const customerId = document.getElementById('invoice-customer-id').value;
                const customerName = document.getElementById('invoice-customer').value;
                const branch = document.getElementById('invoice-branch').value.trim();
                const amount = parseFloat(document.getElementById('invoice-amount').value);
                const description = document.getElementById('invoice-description').value.trim();
                const invoiceNumber = document.getElementById('invoice-number').value.trim();
                const salesman = document.getElementById('invoice-salesman').value.trim();
                const salesmanId = document.getElementById('invoice-salesman-id').value;
                
                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }
                
                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }
                
                // التحقق من صحة اسم الفرع (إذا تم إدخاله)
                if (branch) {
                    if (customer.branches) {
                        const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                        if (!branches.includes(branch)) {
                            alert('الفرع المحدد غير مسجل في فروع العميل. يرجى اختيار فرع من القائمة');
                            return;
                        }
                    }
                }
                
                // التحقق من صحة اسم المندوب
                if (!salesman) {
                    alert('يرجى اختيار مندوب من قائمة المندوبين المسجلين');
                    return;
                }
                
                const salesmanObj = salesmen.find(s => s.name === salesman);
                if (!salesmanObj) {
                    alert('المندوب المحدد غير مسجل. يرجى اختيار مندوب من القائمة');
                    return;
                }
                
                const newInvoice = {
                    id: Date.now().toString(),
                    date: date,
                    customerId: customer.id,
                    customerName: customer.name,
                    branch: branch,
                    amount: amount,
                    description: description,
                    invoiceNumber: invoiceNumber,
                    salesman: salesman,
                    salesmanId: salesmanObj.id,
                    createdAt: new Date().toISOString()
                };
                
                invoices.push(newInvoice);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                
                // إعادة تعيين النموذج
                document.getElementById('invoice-form').reset();
                document.getElementById('invoice-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('invoice-customer').value = '';
                document.getElementById('invoice-customer-id').value = '';
                document.getElementById('invoice-branch').value = '';
                document.getElementById('invoice-salesman').value = '';
                document.getElementById('invoice-salesman-id').value = '';
                
                loadInvoices();
                updateSalesStats();
                alert('تم حفظ الفاتورة بنجاح');
            } catch (error) {
                console.error('Error saving invoice:', error);
                alert('حدث خطأ أثناء حفظ الفاتورة: ' + error.message);
            }
        }
        
        // تحميل الفواتير
        function loadInvoices() {
            const tableBody = document.querySelector('#invoices-table tbody');
            if (!tableBody) return;

            // ترتيب الفواتير حسب التاريخ الأحدث أولاً
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date));

            tableBody.innerHTML = '';

            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td>${invoice.invoiceNumber || '-'}</td>
                    <td>${invoice.customerName}</td>
                    <td>${invoice.branch || '-'}</td>
                    <td>${invoice.salesman || '-'}</td>
                    <td class="text-left">${formatCurrency(invoice.amount)}</td>
                    <td>${invoice.description || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editInvoice('${invoice.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // تحديث إحصائيات المبيعات
        function updateSalesStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayInvoices = invoices.filter(inv => inv.date === today);
            
            document.getElementById('total-invoices-count').textContent = invoices.length;
            document.getElementById('total-invoices-amount').textContent = formatCurrency(
                invoices.reduce((sum, inv) => sum + inv.amount, 0)
            );
            document.getElementById('today-invoices-count').textContent = todayInvoices.length;
            document.getElementById('today-invoices-amount').textContent = formatCurrency(
                todayInvoices.reduce((sum, inv) => sum + inv.amount, 0)
            );
        }
        
        // تعديل الفاتورة
        function editInvoice(id) {
            const invoice = invoices.find(i => i.id === id);
            if (!invoice) return;
            
            document.getElementById('edit-invoice-id').value = invoice.id;
            document.getElementById('edit-invoice-date').value = invoice.date;
            document.getElementById('edit-invoice-customer').value = invoice.customerName;
            document.getElementById('edit-invoice-customer-id').value = invoice.customerId;
            document.getElementById('edit-invoice-branch').value = invoice.branch || '';
            document.getElementById('edit-invoice-amount').value = invoice.amount;
            document.getElementById('edit-invoice-description').value = invoice.description || '';
            document.getElementById('edit-invoice-number').value = invoice.invoiceNumber || '';
            document.getElementById('edit-invoice-salesman').value = invoice.salesman || '';
            document.getElementById('edit-invoice-salesman-id').value = invoice.salesmanId || '';
            
            document.getElementById('edit-invoice-modal').classList.add('active');
        }
        
        function updateInvoice() {
            try {
                const id = document.getElementById('edit-invoice-id').value;
                const date = document.getElementById('edit-invoice-date').value;
                const customerId = document.getElementById('edit-invoice-customer-id').value;
                const customerName = document.getElementById('edit-invoice-customer').value;
                const branch = document.getElementById('edit-invoice-branch').value.trim();
                const amount = parseFloat(document.getElementById('edit-invoice-amount').value);
                const description = document.getElementById('edit-invoice-description').value.trim();
                const invoiceNumber = document.getElementById('edit-invoice-number').value.trim();
                const salesman = document.getElementById('edit-invoice-salesman').value.trim();
                const salesmanId = document.getElementById('edit-invoice-salesman-id').value;
                
                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }
                
                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }
                
                // التحقق من صحة اسم الفرع (إذا تم إدخاله)
                if (branch) {
                    if (customer.branches) {
                        const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                        if (!branches.includes(branch)) {
                            alert('الفرع المحدد غير مسجل في فروع العميل. يرجى اختيار فرع من القائمة');
                            return;
                        }
                    }
                }
                
                // التحقق من صحة اسم المندوب
                if (!salesman) {
                    alert('يرجى اختيار مندوب من قائمة المندوبين المسجلين');
                    return;
                }
                
                const salesmanObj = salesmen.find(s => s.name === salesman);
                if (!salesmanObj) {
                    alert('المندوب المحدد غير مسجل. يرجى اختيار مندوب من القائمة');
                    return;
                }
                
                const invoiceIndex = invoices.findIndex(i => i.id === id);
                if (invoiceIndex === -1) return;
                
                invoices[invoiceIndex].date = date;
                invoices[invoiceIndex].customerId = customerId;
                invoices[invoiceIndex].customerName = customer.name;
                invoices[invoiceIndex].branch = branch;
                invoices[invoiceIndex].amount = amount;
                invoices[invoiceIndex].description = description;
                invoices[invoiceIndex].invoiceNumber = invoiceNumber;
                invoices[invoiceIndex].salesman = salesman;
                invoices[invoiceIndex].salesmanId = salesmanObj.id;
                
                localStorage.setItem('invoices', JSON.stringify(invoices));
                
                document.getElementById('edit-invoice-modal').classList.remove('active');
                loadInvoices();
                updateSalesStats();
                alert('تم تعديل الفاتورة بنجاح');
            } catch (error) {
                console.error('Error updating invoice:', error);
                alert('حدث خطأ أثناء تعديل الفاتورة: ' + error.message);
            }
        }
        
        // حذف الفاتورة
        function deleteInvoice(id) {
            if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
                try {
                    invoices = invoices.filter(invoice => invoice.id !== id);
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    loadInvoices();
                    updateSalesStats();
                } catch (error) {
                    console.error('Error deleting invoice:', error);
                    alert('حدث خطأ أثناء حذف الفاتورة: ' + error.message);
                }
            }
        }
        
        // البحث في الفواتير
        function searchInvoices() {
            const invoiceNumber = document.getElementById('search-invoice-number').value.trim().toLowerCase();
            const customerId = document.getElementById('search-invoice-customer-id').value;
            
            let filteredInvoices = invoices;
            
            if (invoiceNumber) {
                filteredInvoices = filteredInvoices.filter(invoice => 
                    invoice.invoiceNumber && invoice.invoiceNumber.toLowerCase().includes(invoiceNumber)
                );
            }
            
            if (customerId) {
                filteredInvoices = filteredInvoices.filter(invoice => invoice.customerId === customerId);
            }
            
            const tableBody = document.querySelector('#invoices-table tbody');
            tableBody.innerHTML = '';
            
            filteredInvoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td>${invoice.invoiceNumber || '-'}</td>
                    <td>${invoice.customerName}</td>
                    <td>${invoice.branch || '-'}</td>
                    <td>${invoice.salesman || '-'}</td>
                    <td class="text-left">${formatCurrency(invoice.amount)}</td>
                    <td>${invoice.description || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editInvoice('${invoice.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function resetInvoiceSearch() {
            document.getElementById('search-invoice-number').value = '';
            document.getElementById('search-invoice-customer').value = '';
            document.getElementById('search-invoice-customer-id').value = '';
            loadInvoices();
        }
        
        // حفظ المرتجع
        function saveReturn() {
            try {
                const date = document.getElementById('return-date').value;
                const customerId = document.getElementById('return-customer-id').value;
                const customerName = document.getElementById('return-customer').value;
                const branch = document.getElementById('return-branch').value.trim();
                const amount = parseFloat(document.getElementById('return-amount').value);
                const description = document.getElementById('return-description').value.trim();
                const returnNumber = document.getElementById('return-number').value.trim();
                const salesman = document.getElementById('return-salesman').value.trim();
                const salesmanId = document.getElementById('return-salesman-id').value;
                
                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }
                
                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }
                
                // التحقق من صحة اسم الفرع (إذا تم إدخاله)
                if (branch) {
                    if (customer.branches) {
                        const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                        if (!branches.includes(branch)) {
                            alert('الفرع المحدد غير مسجل في فروع العميل. يرجى اختيار فرع من القائمة');
                            return;
                        }
                    }
                }
                
                // التحقق من صحة اسم المندوب
                if (!salesman) {
                    alert('يرجى اختيار مندوب من قائمة المندوبين المسجلين');
                    return;
                }
                
                const salesmanObj = salesmen.find(s => s.name === salesman);
                if (!salesmanObj) {
                    alert('المندوب المحدد غير مسجل. يرجى اختيار مندوب من القائمة');
                    return;
                }
                
                const newReturn = {
                    id: Date.now().toString(),
                    date: date,
                    customerId: customer.id,
                    customerName: customer.name,
                    branch: branch,
                    amount: amount,
                    description: description,
                    returnNumber: returnNumber,
                    salesman: salesman,
                    salesmanId: salesmanObj.id,
                    createdAt: new Date().toISOString()
                };
                
                returns.push(newReturn);
                localStorage.setItem('returns', JSON.stringify(returns));
                
                // إعادة تعيين النموذج
                document.getElementById('return-form').reset();
                document.getElementById('return-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('return-customer').value = '';
                document.getElementById('return-customer-id').value = '';
                document.getElementById('return-branch').value = '';
                document.getElementById('return-salesman').value = '';
                document.getElementById('return-salesman-id').value = '';
                
                loadReturns();
                alert('تم حفظ المرتجع بنجاح');
            } catch (error) {
                console.error('Error saving return:', error);
                alert('حدث خطأ أثناء حفظ المرتجع: ' + error.message);
            }
        }
        
        // تحميل المرتجعات
        function loadReturns() {
            const tableBody = document.querySelector('#returns-table tbody');
            if (!tableBody) return;

            // ترتيب المرتجعات حسب التاريخ الأحدث أولاً
            returns.sort((a, b) => new Date(b.date) - new Date(a.date));

            tableBody.innerHTML = '';

            returns.forEach(ret => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(ret.date)}</td>
                    <td>${ret.returnNumber || '-'}</td>
                    <td>${ret.customerName}</td>
                    <td>${ret.branch || '-'}</td>
                    <td>${ret.salesman || '-'}</td>
                    <td class="text-left">${formatCurrency(ret.amount)}</td>
                    <td>${ret.description || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editReturn('${ret.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteReturn('${ret.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // تعديل المرتجع
        function editReturn(id) {
            const ret = returns.find(r => r.id === id);
            if (!ret) return;
            
            document.getElementById('edit-return-id').value = ret.id;
            document.getElementById('edit-return-date').value = ret.date;
            document.getElementById('edit-return-customer').value = ret.customerName;
            document.getElementById('edit-return-customer-id').value = ret.customerId;
            document.getElementById('edit-return-branch').value = ret.branch || '';
            document.getElementById('edit-return-amount').value = ret.amount;
            document.getElementById('edit-return-description').value = ret.description || '';
            document.getElementById('edit-return-number').value = ret.returnNumber || '';
            document.getElementById('edit-return-salesman').value = ret.salesman || '';
            document.getElementById('edit-return-salesman-id').value = ret.salesmanId || '';
            
            document.getElementById('edit-return-modal').classList.add('active');
        }
        
        function updateReturn() {
            try {
                const id = document.getElementById('edit-return-id').value;
                const date = document.getElementById('edit-return-date').value;
                const customerId = document.getElementById('edit-return-customer-id').value;
                const customerName = document.getElementById('edit-return-customer').value;
                const branch = document.getElementById('edit-return-branch').value.trim();
                const amount = parseFloat(document.getElementById('edit-return-amount').value);
                const description = document.getElementById('edit-return-description').value.trim();
                const returnNumber = document.getElementById('edit-return-number').value.trim();
                const salesman = document.getElementById('edit-return-salesman').value.trim();
                const salesmanId = document.getElementById('edit-return-salesman-id').value;
                
                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }
                
                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }
                
                // التحقق من صحة اسم الفرع (إذا تم إدخاله)
                if (branch) {
                    if (customer.branches) {
                        const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                        if (!branches.includes(branch)) {
                            alert('الفرع المحدد غير مسجل في فروع العميل. يرجى اختيار فرع من القائمة');
                            return;
                        }
                    }
                }
                
                // التحقق من صحة اسم المندوب
                if (!salesman) {
                    alert('يرجى اختيار مندوب من قائمة المندوبين المسجلين');
                    return;
                }
                
                const salesmanObj = salesmen.find(s => s.name === salesman);
                if (!salesmanObj) {
                    alert('المندوب المحدد غير مسجل. يرجى اختيار مندوب من القائمة');
                    return;
                }
                
                const returnIndex = returns.findIndex(r => r.id === id);
                if (returnIndex === -1) return;
                
                returns[returnIndex].date = date;
                returns[returnIndex].customerId = customerId;
                returns[returnIndex].customerName = customer.name;
                returns[returnIndex].branch = branch;
                returns[returnIndex].amount = amount;
                returns[returnIndex].description = description;
                returns[returnIndex].returnNumber = returnNumber;
                returns[returnIndex].salesman = salesman;
                returns[returnIndex].salesmanId = salesmanObj.id;
                
                localStorage.setItem('returns', JSON.stringify(returns));
                
                document.getElementById('edit-return-modal').classList.remove('active');
                loadReturns();
                alert('تم تعديل المرتجع بنجاح');
            } catch (error) {
                console.error('Error updating return:', error);
                alert('حدث خطأ أثناء تعديل المرتجع: ' + error.message);
            }
        }
        
        // البحث في المرتجعات
        function searchReturns() {
            const returnNumber = document.getElementById('search-return-number').value.trim().toLowerCase();
            const customerId = document.getElementById('search-return-customer-id').value;
            
            let filteredReturns = returns;
            
            if (returnNumber) {
                filteredReturns = filteredReturns.filter(ret => 
                    ret.returnNumber && ret.returnNumber.toLowerCase().includes(returnNumber)
                );
            }
            
            if (customerId) {
                filteredReturns = filteredReturns.filter(ret => ret.customerId === customerId);
            }
            
            const tableBody = document.querySelector('#returns-table tbody');
            tableBody.innerHTML = '';
            
            filteredReturns.forEach(ret => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(ret.date)}</td>
                    <td>${ret.returnNumber || '-'}</td>
                    <td>${ret.customerName}</td>
                    <td>${ret.branch || '-'}</td>
                    <td>${ret.salesman || '-'}</td>
                    <td class="text-left">${formatCurrency(ret.amount)}</td>
                    <td>${ret.description || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editReturn('${ret.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteReturn('${ret.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function resetReturnSearch() {
            document.getElementById('search-return-number').value = '';
            document.getElementById('search-return-customer').value = '';
            document.getElementById('search-return-customer-id').value = '';
            loadReturns();
        }
        
        // حذف المرتجع
        function deleteReturn(id) {
            if (confirm('هل أنت متأكد من حذف هذا المرتجع؟')) {
                try {
                    returns = returns.filter(ret => ret.id !== id);
                    localStorage.setItem('returns', JSON.stringify(returns));
                    loadReturns();
                } catch (error) {
                    console.error('Error deleting return:', error);
                    alert('حدث خطأ أثناء حذف المرتجع: ' + error.message);
                }
            }
        }
        
        // حفظ التحصيل
        function savePayment() {
            try {
                const date = document.getElementById('payment-date').value;
                const customerId = document.getElementById('payment-customer-id').value;
                const customerName = document.getElementById('payment-customer').value;
                const branch = document.getElementById('payment-branch').value.trim();
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const voucher = document.getElementById('payment-voucher').value.trim();
                const description = document.getElementById('payment-description').value.trim();
                const discountType = document.getElementById('discount-type').value;
                const paymentType = document.getElementById('payment-type').value;
                
                let discountAmount = 0;
                let discountPercent = 0;
                
                if (discountType === 'percentage') {
                    discountPercent = parseFloat(document.getElementById('discount-percent').value) || 0;
                    discountAmount = amount * (discountPercent / 100);
                } else {
                    discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;
                }
                
                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }
                
                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }
                
                // التحقق من صحة اسم الفرع (إذا تم إدخاله)
                if (branch) {
                    if (customer.branches) {
                        const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                        if (!branches.includes(branch)) {
                            alert('الفرع المحدد غير مسجل في فروع العميل. يرجى اختيار فرع من القائمة');
                            return;
                        }
                    }
                }
                
                const paymentData = {
                    id: Date.now().toString(),
                    date: date,
                    customerId: customer.id,
                    customerName: customer.name,
                    branch: branch,
                    amount: amount,
                    discount: discountAmount,
                    discountPercent: discountPercent,
                    voucher: voucher,
                    description: description,
                    paymentType: paymentType,
                    createdAt: new Date().toISOString()
                };
                
                // إضافة بيانات الشيك إذا كانت طريقة الدفع شيك
                if (paymentType === 'check') {
                    paymentData.checkNumber = document.getElementById('check-number').value.trim();
                    paymentData.bankName = document.getElementById('bank-name').value.trim();
                    paymentData.checkDate = document.getElementById('check-date').value;
                }
                
                payments.push(paymentData);
                localStorage.setItem('payments', JSON.stringify(payments));
                
                // إعادة تعيين النموذج
                document.getElementById('payment-form').reset();
                document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('payment-customer').value = '';
                document.getElementById('payment-customer-id').value = '';
                document.getElementById('current-balance').value = '0.00';
                document.getElementById('discount-percentage').style.display = 'none';
                document.getElementById('discount-amount').style.display = 'block';
                document.getElementById('check-details').style.display = 'none';
                document.querySelector('.payment-type-btn[data-type="cash"]').classList.add('active');
                document.querySelector('.payment-type-btn[data-type="check"]').classList.remove('active');
                document.getElementById('payment-type').value = 'cash';
                
                loadPayments();
                updatePaymentsStats();
                alert('تم حفظ التحصيل بنجاح');
            } catch (error) {
                console.error('Error saving payment:', error);
                alert('حدث خطأ أثناء حفظ التحصيل: ' + error.message);
            }
        }
        
        // تحميل المدفوعات
        function loadPayments() {
            const tableBody = document.querySelector('#payments-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            payments.forEach(payment => {
                const paymentMethod = payment.paymentType === 'check' ? 
                    `شيك (${payment.checkNumber || 'بدون رقم'})` : 'نقدي';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${payment.customerName}</td>
                    <td>${payment.branch || '-'}</td>
                    <td class="text-left">${formatCurrency(payment.amount)}</td>
                    <td class="text-left">${payment.discount > 0 ? formatCurrency(payment.discount) : '-'}</td>
                    <td>${payment.voucher || '-'}</td>
                    <td>${paymentMethod}</td>
                    <td>${payment.description || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editPayment('${payment.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // تحديث إحصائيات التحصيلات
        function updatePaymentsStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayPayments = payments.filter(pay => pay.date === today);
            
            document.getElementById('total-payments-count').textContent = payments.length;
            document.getElementById('total-payments-amount').textContent = formatCurrency(
                payments.reduce((sum, pay) => sum + pay.amount, 0)
            );
            document.getElementById('today-payments-count').textContent = todayPayments.length;
            document.getElementById('today-payments-amount').textContent = formatCurrency(
                todayPayments.reduce((sum, pay) => sum + pay.amount, 0)
            );
        }
        
        // تعديل التحصيل
        function editPayment(id) {
            const payment = payments.find(p => p.id === id);
            if (!payment) return;
            
            document.getElementById('edit-payment-id').value = payment.id;
            document.getElementById('edit-payment-date').value = payment.date;
            document.getElementById('edit-payment-customer').value = payment.customerName;
            document.getElementById('edit-payment-customer-id').value = payment.customerId;
            document.getElementById('edit-payment-branch').value = payment.branch || '';
            document.getElementById('edit-payment-amount').value = payment.amount;
            document.getElementById('edit-discount-amount').value = payment.discount || 0;
            document.getElementById('edit-payment-voucher').value = payment.voucher || '';
            document.getElementById('edit-payment-description').value = payment.description || '';
            document.getElementById('edit-payment-type').value = payment.paymentType || 'cash';
            
            // إعداد طريقة الدفع
            const cashBtn = document.querySelector('#edit-payment-modal .payment-type-btn[data-type="cash"]');
            const checkBtn = document.querySelector('#edit-payment-modal .payment-type-btn[data-type="check"]');
            
            if (payment.paymentType === 'check') {
                cashBtn.classList.remove('active');
                checkBtn.classList.add('active');
                document.getElementById('edit-check-details').style.display = 'block';
                document.getElementById('edit-check-number').value = payment.checkNumber || '';
                document.getElementById('edit-bank-name').value = payment.bankName || '';
                document.getElementById('edit-check-date').value = payment.checkDate || '';
            } else {
                cashBtn.classList.add('active');
                checkBtn.classList.remove('active');
                document.getElementById('edit-check-details').style.display = 'none';
            }
            
            document.getElementById('edit-payment-modal').classList.add('active');
        }
        
        function updatePayment() {
            try {
                const id = document.getElementById('edit-payment-id').value;
                const date = document.getElementById('edit-payment-date').value;
                const customerId = document.getElementById('edit-payment-customer-id').value;
                const customerName = document.getElementById('edit-payment-customer').value;
                const branch = document.getElementById('edit-payment-branch').value.trim();
                const amount = parseFloat(document.getElementById('edit-payment-amount').value);
                const discount = parseFloat(document.getElementById('edit-discount-amount').value) || 0;
                const voucher = document.getElementById('edit-payment-voucher').value.trim();
                const description = document.getElementById('edit-payment-description').value.trim();
                const paymentType = document.getElementById('edit-payment-type').value;
                
                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }
                
                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }
                
                // التحقق من صحة اسم الفرع (إذا تم إدخاله)
                if (branch) {
                    if (customer.branches) {
                        const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                        if (!branches.includes(branch)) {
                            alert('الفرع المحدد غير مسجل في فروع العميل. يرجى اختيار فرع من القائمة');
                            return;
                        }
                    }
                }
                
                const paymentIndex = payments.findIndex(p => p.id === id);
                if (paymentIndex === -1) return;
                
                payments[paymentIndex].date = date;
                payments[paymentIndex].customerId = customerId;
                payments[paymentIndex].customerName = customer.name;
                payments[paymentIndex].branch = branch;
                payments[paymentIndex].amount = amount;
                payments[paymentIndex].discount = discount;
                payments[paymentIndex].voucher = voucher;
                payments[paymentIndex].description = description;
                payments[paymentIndex].paymentType = paymentType;
                
                // تحديث بيانات الشيك إذا كانت طريقة الدفع شيك
                if (paymentType === 'check') {
                    payments[paymentIndex].checkNumber = document.getElementById('edit-check-number').value.trim();
                    payments[paymentIndex].bankName = document.getElementById('edit-bank-name').value.trim();
                    payments[paymentIndex].checkDate = document.getElementById('edit-check-date').value;
                } else {
                    delete payments[paymentIndex].checkNumber;
                    delete payments[paymentIndex].bankName;
                    delete payments[paymentIndex].checkDate;
                }
                
                localStorage.setItem('payments', JSON.stringify(payments));
                
                document.getElementById('edit-payment-modal').classList.remove('active');
                loadPayments();
                updatePaymentsStats();
                alert('تم تعديل سند التحصيل بنجاح');
            } catch (error) {
                console.error('Error updating payment:', error);
                alert('حدث خطأ أثناء تعديل التحصيل: ' + error.message);
            }
        }
        
        // البحث في المدفوعات
        function searchPayments() {
            const customerId = document.getElementById('search-payment-customer-id').value;
            
            let filteredPayments = payments;
            
            if (customerId) {
                filteredPayments = filteredPayments.filter(payment => payment.customerId === customerId);
            }
            
            const tableBody = document.querySelector('#payments-table tbody');
            tableBody.innerHTML = '';
            
            filteredPayments.forEach(payment => {
                const paymentMethod = payment.paymentType === 'check' ? 
                    `شيك (${payment.checkNumber || 'بدون رقم'})` : 'نقدي';
                    
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${payment.customerName}</td>
                    <td>${payment.branch || '-'}</td>
                    <td class="text-left">${formatCurrency(payment.amount)}</td>
                    <td class="text-left">${payment.discount > 0 ? formatCurrency(payment.discount) : '-'}</td>
                    <td>${payment.voucher || '-'}</td>
                    <td>${paymentMethod}</td>
                    <td>${payment.description || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editPayment('${payment.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function resetPaymentSearch() {
            document.getElementById('search-payment-customer').value = '';
            document.getElementById('search-payment-customer-id').value = '';
            loadPayments();
        }
        
        // حذف التحصيل
        function deletePayment(id) {
            if (confirm('هل أنت متأكد من حذف هذا التحصيل؟')) {
                try {
                    payments = payments.filter(payment => payment.id !== id);
                    localStorage.setItem('payments', JSON.stringify(payments));
                    loadPayments();
                    updatePaymentsStats();
                } catch (error) {
                    console.error('Error deleting payment:', error);
                    alert('حدث خطأ أثناء حذف التحصيل: ' + error.message);
                }
            }
        }
        
        // حفظ الرصيد الافتتاحي
        function saveOpeningBalance() {
            try {
                const customerId = document.getElementById('balance-customer-id').value;
                const customerName = document.getElementById('balance-customer').value;
                const branch = document.getElementById('balance-branch').value.trim();
                const date = document.getElementById('balance-date').value;
                const balance = parseFloat(document.getElementById('opening-balance').value);
                
                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }
                
                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }
                
                // التحقق من صحة اسم الفرع
                if (!branch) {
                    alert('يرجى اختيار فرع من قائمة فروع العميل');
                    return;
                }
                
                if (customer.branches) {
                    const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                    if (!branches.includes(branch)) {
                        alert('الفرع المحدد غير مسجل في فروع العميل. يرجى اختيار فرع من القائمة');
                        return;
                    }
                }
                
                const newBalance = {
                    id: Date.now().toString(),
                    customerId: customer.id,
                    customerName: customer.name,
                    branch: branch,
                    balance: balance,
                    date: date,
                    createdAt: new Date().toISOString()
                };
                
                openingBalances.push(newBalance);
                localStorage.setItem('openingBalances', JSON.stringify(openingBalances));
                
                document.getElementById('opening-balance-form').reset();
                document.getElementById('balance-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('balance-customer').value = '';
                document.getElementById('balance-customer-id').value = '';
                document.getElementById('balance-branch').value = '';
                
                loadOpeningBalances();
                alert('تم حفظ الرصيد الافتتاحي بنجاح');
            } catch (error) {
                console.error('Error saving opening balance:', error);
                alert('حدث خطأ أثناء حفظ الرصيد الافتتاحي: ' + error.message);
            }
        }
        
        // تحميل الارصدة الافتتاحية
        function loadOpeningBalances() {
            const tableBody = document.querySelector('#balances-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            openingBalances.forEach(balance => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${balance.customerName}</td>
                    <td>${balance.branch || '-'}</td>
                    <td>${formatDate(balance.date)}</td>
                    <td class="text-left">${formatCurrency(balance.balance)}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editOpeningBalance('${balance.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOpeningBalance('${balance.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // تعديل الرصيد الافتتاحي
        function editOpeningBalance(id) {
            const balance = openingBalances.find(b => b.id === id);
            if (!balance) return;
            
            document.getElementById('edit-balance-id').value = balance.id;
            document.getElementById('edit-balance-customer').value = balance.customerName;
            document.getElementById('edit-balance-customer-id').value = balance.customerId;
            document.getElementById('edit-balance-branch').value = balance.branch || '';
            document.getElementById('edit-balance-date').value = balance.date;
            document.getElementById('edit-opening-balance').value = balance.balance;
            
            document.getElementById('edit-balance-modal').classList.add('active');
        }
        
        function updateOpeningBalance() {
            try {
                const id = document.getElementById('edit-balance-id').value;
                const customerId = document.getElementById('edit-balance-customer-id').value;
                const customerName = document.getElementById('edit-balance-customer').value;
                const branch = document.getElementById('edit-balance-branch').value.trim();
                const date = document.getElementById('edit-balance-date').value;
                const balance = parseFloat(document.getElementById('edit-opening-balance').value);
                
                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }
                
                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }
                
                // التحقق من صحة اسم الفرع
                if (!branch) {
                    alert('يرجى اختيار فرع من قائمة فروع العميل');
                    return;
                }
                
                if (customer.branches) {
                    const branches = customer.branches.split(',').map(b => b.trim()).filter(b => b);
                    if (!branches.includes(branch)) {
                        alert('الفرع المحدد غير مسجل في فروع العميل. يرجى اختيار فرع من القائمة');
                        return;
                    }
                }
                
                const balanceIndex = openingBalances.findIndex(b => b.id === id);
                if (balanceIndex === -1) return;
                
                openingBalances[balanceIndex].customerId = customerId;
                openingBalances[balanceIndex].customerName = customer.name;
                openingBalances[balanceIndex].branch = branch;
                openingBalances[balanceIndex].date = date;
                openingBalances[balanceIndex].balance = balance;
                openingBalances[balanceIndex].updatedAt = new Date().toISOString();
                
                localStorage.setItem('openingBalances', JSON.stringify(openingBalances));
                
                document.getElementById('edit-balance-modal').classList.remove('active');
                loadOpeningBalances();
                alert('تم تعديل الرصيد الافتتاحي بنجاح');
            } catch (error) {
                console.error('Error updating opening balance:', error);
                alert('حدث خطأ أثناء تعديل الرصيد الافتتاحي: ' + error.message);
            }
        }
        
        // حذف الرصيد الافتتاحي
        function deleteOpeningBalance(id) {
            if (confirm('هل أنت متأكد من حذف هذا الرصيد الافتتاحي؟')) {
                try {
                    openingBalances = openingBalances.filter(balance => balance.id !== id);
                    localStorage.setItem('openingBalances', JSON.stringify(openingBalances));
                    loadOpeningBalances();
                } catch (error) {
                    console.error('Error deleting opening balance:', error);
                    alert('حدث خطأ أثناء حذف الرصيد الافتتاحي: ' + error.message);
                }
            }
        }
        
        // توليد كشف الحساب
        function generateStatement() {
            try {
                const customerId = document.getElementById('statement-customer-id').value;
                const customerName = document.getElementById('statement-customer').value;
                const branch = document.getElementById('statement-branch').value.trim();
                const startDateInput = document.getElementById('start-date').value;
                const endDateInput = document.getElementById('end-date').value;

                if (!customerId || !customerName) {
                    alert('يرجى اختيار عميل');
                    return;
                }

                const customer = customers.find(s => s.id === customerId);
                if (!customer) {
                    alert('العميل المحدد غير موجود');
                    return;
                }

                // الحصول على الرصيد الافتتاحي
                let openingBalance = 0;
                let openingBalanceObj = null;
                
                if (branch) {
                    const branchBalances = openingBalances.filter(b => 
                        b.customerId === customerId && b.branch === branch
                    );
                    if (branchBalances.length > 0) {
                        openingBalance = branchBalances.reduce((sum, b) => sum + b.balance, 0);
                        openingBalanceObj = branchBalances[0];
                    }
                } else {
                    const customerBalances = openingBalances.filter(b => b.customerId === customerId);
                    if (customerBalances.length > 0) {
                        openingBalance = customerBalances.reduce((sum, b) => sum + b.balance, 0);
                        openingBalanceObj = customerBalances[0];
                    }
                }

                // حساب الرصيد الافتتاحي الفعلي للفترة المحددة
                let actualOpeningBalance = openingBalance;

                // إذا كان هناك رصيد افتتاحي
                if (openingBalanceObj) {
                    const balanceDate = new Date(openingBalanceObj.date);
                    const startDate = new Date(startDateInput);

                    // إذا كان تاريخ الرصيد الافتتاحي قبل تاريخ البداية
                    if (balanceDate < startDate) {
                        // حساب جميع الحركات قبل تاريخ البداية
                        let invoicesBefore;
                        if (branch) {
                            invoicesBefore = invoices.filter(inv => 
                                inv.customerId === customerId && 
                                inv.branch === branch &&
                                new Date(inv.date) < startDate
                            );
                        } else {
                            invoicesBefore = invoices.filter(inv => 
                                inv.customerId === customerId && 
                                new Date(inv.date) < startDate
                            );
                        }

                        let returnsBefore;
                        if (branch) {
                            returnsBefore = returns.filter(ret => 
                                ret.customerId === customerId && 
                                ret.branch === branch &&
                                new Date(ret.date) < startDate
                            );
                        } else {
                            returnsBefore = returns.filter(ret => 
                                ret.customerId === customerId && 
                                new Date(ret.date) < startDate
                            );
                        }

                        let paymentsBefore;
                        if (branch) {
                            paymentsBefore = payments.filter(pay => 
                                pay.customerId === customerId && 
                                pay.branch === branch &&
                                new Date(pay.date) < startDate
                            );
                        } else {
                            paymentsBefore = payments.filter(pay => 
                                pay.customerId === customerId && 
                                new Date(pay.date) < startDate
                            );
                        }

                        // حساب الرصيد الفعلي أول المدة
                        invoicesBefore.forEach(inv => actualOpeningBalance += inv.amount);
                        returnsBefore.forEach(ret => actualOpeningBalance -= ret.amount);
                        paymentsBefore.forEach(pay => actualOpeningBalance -= (pay.amount + (pay.discount || 0)));
                    }
                }

                // جمع الفواتير والمرتجعات والمدفوعات ضمن الفترة المحددة
                let customerInvoices;
                if (branch) {
                    customerInvoices = invoices.filter(inv => 
                        inv.customerId === customerId && 
                        inv.branch === branch &&
                        new Date(inv.date) >= new Date(startDateInput) && 
                        new Date(inv.date) <= new Date(endDateInput)
                    );
                } else {
                    customerInvoices = invoices.filter(inv => 
                        inv.customerId === customerId && 
                        new Date(inv.date) >= new Date(startDateInput) && 
                        new Date(inv.date) <= new Date(endDateInput)
                    );
                }
                // ترتيب الفواتير من الأقدم إلى الأحدث
                customerInvoices.sort((a, b) => new Date(a.date) - new Date(b.date));

                let customerReturns;
                if (branch) {
                    customerReturns = returns.filter(ret => 
                        ret.customerId === customerId && 
                        ret.branch === branch &&
                        new Date(ret.date) >= new Date(startDateInput) && 
                        new Date(ret.date) <= new Date(endDateInput)
                    );
                } else {
                    customerReturns = returns.filter(ret => 
                        ret.customerId === customerId && 
                        new Date(ret.date) >= new Date(startDateInput) && 
                        new Date(ret.date) <= new Date(endDateInput)
                    );
                }
                // ترتيب المرتجعات من الأقدم إلى الأحدث
                customerReturns.sort((a, b) => new Date(a.date) - new Date(b.date));

                let customerPayments;
                if (branch) {
                    customerPayments = payments.filter(pay => 
                        pay.customerId === customerId && 
                        pay.branch === branch &&
                        new Date(pay.date) >= new Date(startDateInput) && 
                        new Date(pay.date) <= new Date(endDateInput)
                    );
                } else {
                    customerPayments = payments.filter(pay => 
                        pay.customerId === customerId && 
                        new Date(pay.date) >= new Date(startDateInput) && 
                        new Date(pay.date) <= new Date(endDateInput)
                    );
                }
                // ترتيب المدفوعات من الأقدم إلى الأحدث
                customerPayments.sort((a, b) => new Date(a.date) - new Date(b.date));

                // دجم الفواتير والمرتجعات والمدفوعات في قائمة واحدة وترتيبها من الأقدم إلى الأحدث
                const allTransactions = [];
                
                // إضافة الفواتير
                customerInvoices.forEach(invoice => {
                    allTransactions.push({
                        date: new Date(invoice.date),
                        type: 'فاتورة',
                        data: invoice
                    });
                });
                
                // إضافة المرتجعات
                customerReturns.forEach(ret => {
                    allTransactions.push({
                        date: new Date(ret.date),
                        type: 'مرتجع',
                        data: ret
                    });
                });
                
                // إضافة المدفوعات
                customerPayments.forEach(payment => {
                    allTransactions.push({
                        date: new Date(payment.date),
                        type: 'تحصيل',
                        data: payment
                    });
                    
                    if (payment.discount > 0) {
                        allTransactions.push({
                            date: new Date(payment.date),
                            type: 'خصم',
                            data: payment
                        });
                    }
                });
                
                // ترتيب جميع المعاملات من الأقدم إلى الأحدث
                allTransactions.sort((a, b) => a.date - b.date);
                
                // إنشاء قائمة المعاملات مع حساب الرصيد المتجمع
                const transactions = [];
                let currentBalance = actualOpeningBalance;

                // إضافة الرصيد الافتتاحي إذا كان غير صفر
                if (actualOpeningBalance !== 0) {
                    transactions.push({
                        date: formatDate(startDateInput),
                        type: 'رصيد أول المدة',
                        description: 'رصيد أول المدة',
                        branch: openingBalanceObj ? openingBalanceObj.branch : '',
                        debit: 0,
                        credit: 0,
                        balance: actualOpeningBalance
                    });
                }

                // معالجة كل المعاملات بالترتيب
                allTransactions.forEach(transaction => {
                    if (transaction.type === 'فاتورة') {
                        const invoice = transaction.data;
                        currentBalance += invoice.amount;
                        transactions.push({
                            date: formatDate(invoice.date),
                            type: 'فاتورة',
                            invoiceNumber: invoice.invoiceNumber,
                            voucher: '',
                            salesman: invoice.salesman,
                            branch: invoice.branch,
                            description: invoice.description || `فاتورة ${invoice.invoiceNumber || ''}`.trim(),
                            debit: invoice.amount,
                            credit: 0,
                            balance: currentBalance
                        });
                    } else if (transaction.type === 'مرتجع') {
                        const ret = transaction.data;
                        currentBalance -= ret.amount;
                        transactions.push({
                            date: formatDate(ret.date),
                            type: 'مرتجع',
                            invoiceNumber: ret.returnNumber,
                            voucher: '',
                            salesman: ret.salesman,
                            branch: ret.branch,
                            description: ret.description || `مرتجع ${ret.returnNumber || ''}`.trim(),
                            debit: 0,
                            credit: ret.amount,
                            balance: currentBalance
                        });
                    } else if (transaction.type === 'تحصيل') {
                        const payment = transaction.data;
                        currentBalance -= payment.amount;
                        transactions.push({
                            date: formatDate(payment.date),
                            type: 'تحصيل',
                            invoiceNumber: '',
                            voucher: payment.voucher,
                            salesman: '',
                            branch: payment.branch,
                            description: payment.description || `تحصيل ${payment.voucher ? `(سند: ${payment.voucher})` : ''}`,
                            debit: 0,
                            credit: payment.amount,
                            balance: currentBalance
                        });
                    } else if (transaction.type === 'خصم') {
                        const payment = transaction.data;
                        currentBalance -= payment.discount;
                        let discountDesc = `خصم ${payment.discountPercent > 0 ? `(${payment.discountPercent}%)` : ''}`;
                        if (payment.description) {
                            discountDesc += ` - ${payment.description}`;
                        }
                        
                        transactions.push({
                            date: formatDate(payment.date),
                            type: 'خصم',
                            invoiceNumber: '',
                            voucher: payment.voucher,
                            salesman: '',
                            branch: payment.branch,
                            description: discountDesc,
                            debit: 0,
                            credit: payment.discount,
                            balance: currentBalance
                        });
                    }
                });

                // عرض النتائج
                displayStatement(customer, branch, actualOpeningBalance, transactions, startDateInput, endDateInput);
                
            } catch (error) {
                console.error('Error generating statement:', error);
                alert('حدث خطأ أثناء توليد كشف الحساب: ' + error.message);
            }
        }

        // دالة عرض كشف الحساب
        function displayStatement(customer, branch, openingBalance, transactions, startDate, endDate) {
            const resultsContainer = document.getElementById('statement-results');
            const summaryContainer = document.getElementById('statement-summary');
            const tableBody = document.querySelector('#statement-table tbody');
            const totalsContainer = document.getElementById('statement-totals');
            
            // تحديث معلومات العرض
            document.getElementById('display-customer-name').textContent = customer.name;
            document.getElementById('display-branch-name').textContent = branch || 'جميع الفروع';
            document.getElementById('display-start-date').textContent = formatDate(startDate);
            document.getElementById('display-end-date').textContent = formatDate(endDate);
            document.getElementById('display-print-date').textContent = formatDate(new Date().toISOString());
            
            // تحديث معلومات PDF
            document.getElementById('pdf-customer-name').textContent = customer.name;
            document.getElementById('pdf-branch-name').textContent = branch || 'جميع الفروع';
            document.getElementById('pdf-start-date').textContent = formatDate(startDate);
            document.getElementById('pdf-end-date').textContent = formatDate(endDate);
            document.getElementById('pdf-print-date').textContent = formatDate(new Date().toISOString());
            
            // حساب الإجماليات
            let totalDebit = 0;
            let totalCredit = 0;
            let totalDiscount = 0;
            
            transactions.forEach(transaction => {
                totalDebit += transaction.debit;
                totalCredit += transaction.credit;
                if (transaction.type === 'خصم') {
                    totalDiscount += transaction.credit;
                }
            });
            
            const finalBalance = openingBalance + totalDebit - totalCredit;
            
            // تحديث الملخص للعرض
            summaryContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                    <div style="margin-bottom: 10px;">
                        <strong>الرصيد الافتتاحي:</strong> 
                        <span class="balance-amount">${formatCurrency(openingBalance)}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>إجمالي المبيعات:</strong> 
                        <span class="debit-amount">${formatCurrency(totalDebit)}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>إجمالي المرتجعات:</strong> 
                        <span class="credit-amount">${formatCurrency(transactions.filter(t => t.type === 'مرتجع').reduce((sum, t) => sum + t.credit, 0))}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>إجمالي التحصيل:</strong> 
                        <span class="credit-amount">${formatCurrency(transactions.filter(t => t.type === 'تحصيل').reduce((sum, t) => sum + t.credit, 0))}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>إجمالي الخصم:</strong> 
                        <span class="discount-amount">${formatCurrency(totalDiscount)}</span>
                    </div>
                </div>
            `;
            
            // تحديث الملخص لـ PDF
            document.getElementById('pdf-summary').innerHTML = summaryContainer.innerHTML;
            
            // إعداد جدول المعاملات للعرض
            tableBody.innerHTML = '';
            
            // إضافة الرصيد الافتتاحي كأول صف
            if (openingBalance !== 0) {
                const openingRow = document.createElement('tr');
                openingRow.innerHTML = `
                    <td style="font-size: 12px; direction: ltr; text-align: left;">${formatDate(startDate)}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>${transactions.find(t => t.type === 'رصيد أول المدة')?.branch || ''}</td>
                    <td style="text-align: right;">رصيد أول المدة</td>
                    <td class="text-left"></td>
                    <td class="text-left"></td>
                    <td class="text-left balance-amount">${formatCurrency(openingBalance)}</td>
                `;
                tableBody.appendChild(openingRow);
            }
            
            // إضافة المعاملات
            transactions.forEach(transaction => {
                if (transaction.type !== 'رصيد أول المدة') {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-size: 12px; direction: ltr; text-align: left;">${transaction.date}</td>
                        <td>${transaction.invoiceNumber || ''}</td>
                        <td>${transaction.voucher || ''}</td>
                        <td>${transaction.salesman || ''}</td>
                        <td>${transaction.branch || ''}</td>
                        <td style="text-align: right;">${transaction.description}</td>
                        <td class="text-left debit-amount">${transaction.debit > 0 ? formatCurrency(transaction.debit) : ''}</td>
                        <td class="text-left ${transaction.type === 'خصم' ? 'discount-amount' : 'credit-amount'}">${transaction.credit > 0 ? formatCurrency(transaction.credit) : ''}</td>
                        <td class="text-left balance-amount ${transaction.balance >= 0 ? 'credit-amount' : 'debit-amount'}">
                            ${formatCurrency(transaction.balance)}
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
            
            // إضافة صف الإجماليات
            totalsContainer.innerHTML = '';
            const totalsRow = document.createElement('tr');
            totalsRow.className = 'totals-row';
            totalsRow.innerHTML = `
                <td colspan="6" style="text-align: center; font-weight: bold;">الإجمالي</td>
                <td class="text-left debit-amount" style="font-weight: bold;">${formatCurrency(totalDebit)}</td>
                <td class="text-left credit-amount" style="font-weight: bold;">${formatCurrency(totalCredit)}</td>
                <td class="text-left balance-amount" style="font-weight: bold;">${formatCurrency(finalBalance)}</td>
            `;
            totalsContainer.appendChild(totalsRow);
            
            // تحديث جدول PDF
            const pdfTableBody = document.querySelector('#pdf-statement-table tbody');
            pdfTableBody.innerHTML = tableBody.innerHTML;
            
            // تحديث الإجماليات لـ PDF
            const pdfTotalsContainer = document.getElementById('pdf-totals');
            pdfTotalsContainer.innerHTML = totalsContainer.innerHTML;
            
            // إظهار النتائج
            resultsContainer.classList.remove('hidden');
        }

        // دالة حفظ PDF
        function saveAsPDF() {
            if (!window.jspdf) {
                alert('مكتبة PDF غير محملة. يرجى تحديث الصفحة.');
                return;
            }
            
            // التحقق من وجود بيانات للتصدير
            if (document.getElementById('statement-results').classList.contains('hidden')) {
                alert('يرجى عرض كشف الحساب أولاً قبل التصدير إلى PDF');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const element = document.getElementById('pdf-template');
                
                // نسخ البيانات من العرض إلى قالب PDF
                updatePDFTemplate();
                
                // إظهار العنصر مؤقتاً لالتقاط الصورة
                const originalDisplay = element.style.display;
                const originalPosition = element.style.position;
                const originalLeft = element.style.left;
                const originalTop = element.style.top;
                const originalWidth = element.style.width;
                const originalHeight = element.style.height;
                const originalZIndex = element.style.zIndex;
                
                element.style.display = 'block';
                element.style.position = 'fixed';
                element.style.left = '0';
                element.style.top = '0';
                element.style.width = '794px';
                element.style.height = '1123px';
                element.style.zIndex = '10000';
                element.style.background = 'white';
                
                // استخدام html2canvas لالتقاط الصورة
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#FFFFFF',
                    width: 794,
                    height: 1123,
                    windowWidth: 794,
                    windowHeight: 1123
                }).then(canvas => {
                    // إعادة العنصر إلى وضعه الأصلي
                    element.style.display = originalDisplay;
                    element.style.position = originalPosition;
                    element.style.left = originalLeft;
                    element.style.top = originalTop;
                    element.style.width = originalWidth;
                    element.style.height = originalHeight;
                    element.style.zIndex = originalZIndex;
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const pdf = new jsPDF('p', 'pt', 'a4');
                    
                    const imgWidth = pdf.internal.pageSize.getWidth();
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // الصفحة الأولى
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    
                    const customerName = document.getElementById('statement-customer').value;
                    const branch = document.getElementById('statement-branch').value;
                    
                    // تنظيف اسم الملف من الأحغير غير المرغوبة
                    const cleanCustomerName = customerName.replace(/[^\w\u0600-\u06FF\s]/g, '');
                    const cleanBranch = branch ? branch.replace(/[^\w\u0600-\u06FF\s]/g, '') : 'all';
                    const fileName = `كشف_حساب_${cleanCustomerName}_${cleanBranch}.pdf`;
                    
                    pdf.save(fileName);
                    
                }).catch(error => {
                    console.error('Error generating canvas:', error);
                    // إعادة العنصر إلى وضعه الأصلي في حالة الخطأ
                    element.style.display = originalDisplay;
                    element.style.position = originalPosition;
                    element.style.left = originalLeft;
                    element.style.top = originalTop;
                    element.style.width = originalWidth;
                    element.style.height = originalHeight;
                    element.style.zIndex = originalZIndex;
                    
                    alert('حدث خطأ أثناء إنشاء PDF: ' + error.message);
                });
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('حدث خطأ أثناء إنشاء ملف PDF: ' + error.message);
            }
        }

        // دالة تحديث قالب PDF بالبيانات
        function updatePDFTemplate() {
            // نسخ البيانات من العرض الرئيسي إلى قالب PDF
            const displayCustomerName = document.getElementById('display-customer-name').textContent;
            const displayBranchName = document.getElementById('display-branch-name').textContent;
            const displayStartDate = document.getElementById('display-start-date').textContent;
            const displayEndDate = document.getElementById('display-end-date').textContent;
            const displaySummary = document.getElementById('statement-summary').innerHTML;
            const displayTableBody = document.querySelector('#statement-table tbody').innerHTML;
            const displayTotals = document.getElementById('statement-totals').innerHTML;
            
            document.getElementById('pdf-customer-name').textContent = displayCustomerName;
            document.getElementById('pdf-branch-name').textContent = displayBranchName;
            document.getElementById('pdf-start-date').textContent = displayStartDate;
            document.getElementById('pdf-end-date').textContent = displayEndDate;
            document.getElementById('pdf-summary').innerHTML = displaySummary;
            document.querySelector('#pdf-statement-table tbody').innerHTML = displayTableBody;
            document.getElementById('pdf-totals').innerHTML = displayTotals;
            
            // تحديث تاريخ الطباعة
            const now = new Date();
            const formattedDate = formatDate(now.toISOString());
            document.getElementById('pdf-print-date').textContent = formattedDate;
        }

        // دالة الطباعة
        function printStatement() {
            const printContent = document.getElementById('statement-results');
            
            if (printContent.classList.contains('hidden')) {
                alert('يرجى عرض كشف الحساب أولاً');
                return;
            }
            
            const originalContent = document.body.innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب عميل</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', serif; 
                            margin: 20px;
                            direction: rtl;
                            font-size: 14px;
                        }
                        .statement-header { 
                            text-align: center; 
                            padding-bottom: 15px; 
                            margin-bottom: 20px; 
                        }
                        .statement-info-row { 
                            margin-bottom: 15px; 
                            font-size: 16px;
                        }
                        .customer-name-large {
                            font-size: 20px;
                            font-weight: bold;
                            margin-bottom: 20px;
                        }
                        .branch-info {
                            font-size: 18px;
                            margin-bottom: 20px;
                        }
                        .period-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 20px;
                            font-size: 16px;
                        }
                        .statement-summary { 
                            background: #f0f0f0; 
                            padding: 15px; 
                            margin-bottom: 20px; 
                            border-right: 4px solid #000;
                            font-size: 12px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 15px;
                            font-size: 12px;
                        }
                        th { 
                            background: #333; 
                            color: white; 
                            padding: 8px; 
                            border: 1px solid #000;
                            text-align: center;
                        }
                        td { 
                            padding: 8px; 
                            border: 1px solid #000; 
                            text-align: center;
                            min-height: 42px;
                            height: 42px;
                        }
                        .debit-amount { color: #d00; font-weight: bold; }
                        .credit-amount { color: #080; font-weight: bold; }
                        .discount-amount { color: #ffc107; font-weight: bold; }
                        .balance-amount { color: #00f; font-weight: bold; }
                        .text-left { text-align: left !important; direction: ltr !important; }
                        .totals-row {
                            background-color: #f0f8ff !important;
                            font-weight: bold;
                            border-top: 2px solid #000;
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // البحث في العملاء
        function searchCustomers() {
            const searchTerm = document.getElementById('search-customer-name').value.trim().toLowerCase();
            
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm)
            );
            
            const tableBody = document.querySelector('#customers-table tbody');
            tableBody.innerHTML = '';
            
            filteredCustomers.forEach(customer => {
                const branches = customer.branches ? customer.branches.split(',').map(b => b.trim()).filter(b => b) : [];
                const branchesDisplay = branches.map(branch => 
                    `<span class="branch-tag">${branch}</span>`
                ).join(' ');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.name}</td>
                    <td>${branchesDisplay || '-'}</td>
                    <td>${customer.contact || '-'}</td>
                    <td>${formatDate(customer.createdAt)}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editCustomer('${customer.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function resetCustomerSearch() {
            document.getElementById('search-customer-name').value = '';
            loadCustomers();
        }
        
        // البحث في المندوبين
        function searchSalesmen() {
            const searchTerm = document.getElementById('search-salesman-name').value.trim().toLowerCase();
            
            const filteredSalesmen = salesmen.filter(salesman => 
                salesman.name.toLowerCase().includes(searchTerm)
            );
            
            const tableBody = document.querySelector('#salesmen-table tbody');
            tableBody.innerHTML = '';
            
            filteredSalesmen.forEach(salesman => {
                const invoiceCount = invoices.filter(inv => 
                    inv.salesmanId === salesman.id || inv.salesman === salesman.name
                ).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${salesman.name}</td>
                    <td>${salesman.phone || '-'}</td>
                    <td>${salesman.email || '-'}</td>
                    <td>${formatDate(salesman.createdAt)}</td>
                    <td>${invoiceCount}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editSalesman('${salesman.id}')"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSalesman('${salesman.id}')"><i class="fas fa-trash"></i> حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function resetSalesmanSearch() {
            document.getElementById('search-salesman-name').value = '';
            loadSalesmen();
        }
        
        // دالة تنسيق التاريخ (بتنسيق 25-12-2025)
        function formatDate(dateString) {
            if (!dateString) return '';
            
            try {
                const dateObj = new Date(dateString);
                if (isNaN(dateObj.getTime())) {
                    // إذا كان التاريخ بالفعل بتنسيق dd-mm-yyyy
                    if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
                        return dateString;
                    }
                    return dateString;
                }
                
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                
                return `${day}-${month}-${year}`;
            } catch (error) {
                return dateString;
            }
        }

        // دالة تنسيق العملة
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // البحث في الفواتير
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-invoice');
            
            searchInput.addEventListener('input', function() {
                const filter = searchInput.value.toLowerCase();
                const tableBody = document.querySelector('#invoices-table tbody');
                const rows = tableBody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    let found = false;
                    for (let j = 0; j < cells.length; j++) {
                        if (cells[j].textContent.toLowerCase().includes(filter)) {
                            found = true;
                            break;
                        }
                    }
                    rows[i].style.display = found ? '' : 'none';
                }
            });
        });

        // البحث في المرتجعات
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-return');
            
            searchInput.addEventListener('input', function() {
                const filter = searchInput.value.toLowerCase();
                const tableBody = document.querySelector('#returns-table tbody');
                const rows = tableBody.getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    let found = false;
                    for (let j = 0; j < cells.length; j++) {
                        if (cells[j].textContent.toLowerCase().includes(filter)) {
                            found = true;
                            break;
                        }
                    }
                    rows[i].style.display = found ? '' : 'none';
                }
            });
        });

        // تصدير الجداول إلى Excel
        function exportToExcel(tableId, fileName) {
            try {
                const table = document.getElementById(tableId);
                if (!table) {
                    alert('الجدول غير موجود');
                    return;
                }
                
                const ws = XLSX.utils.table_to_sheet(table);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "البيانات");

                XLSX.writeFile(wb, fileName);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('حدث خطأ أثناء التصدير إلى Excel: ' + error.message);
            }
        }
    </script>
</body>
</html>